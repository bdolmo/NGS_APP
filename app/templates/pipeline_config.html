{% extends "base.html" %}

{% block body %}
<div class="container-fluid py-4">

  <style>
    .inline-chip { display:inline-flex; align-items:center; gap:.6rem; }
    .numberCircle{
      width: 34px; height: 34px; border-radius: 50%;
      border: 0px solid currentColor; display:inline-flex;
      align-items:center; justify-content:center; font-size:22px;font-weight:500; line-height:1;
    }
    .tab-sticky { position: sticky; top: 0; z-index: 1; background: var(--bs-body-bg); }
  </style>

  <div class="row">
    <div class="col-12 mb-3 d-flex align-items-center justify-content-between">
      <h2 class="mb-0 ml-4">{{ pipeline_name }}</h2>
    </div>
  </div>



  <div class="tab-content border-bottom border-start border-end p-3 rounded-bottom" id="cfgTabsContent">

    <!-- PAS 1: Enganxa i analitza -->
    <div class="tab-pane fade show active" id="define" role="tabpanel" aria-labelledby="define-tab">
      <div class="row g-3">
        <div class="col-lg-3">
          <div class="card shadow-sm">
            <div class="card-body">

              <div class="inline-chip mb-2">
                <div class="numberCircle">1</div>
                <div><b>Lectura command line</b></div>
              </div>

              <textarea id="cli_text" class="form-control" rows="6" placeholder="p. ex.:
python3 /home/udmmp/GC_NGS_PIPELINE/gc_ngs_pipeline.py all -s targeted --panel /ngs-db/PANELS_DB/data/AGILENT_GLOBAL/S3471352_Covered.sorted.merged.bed --panel_name AGILENT_GLOBAL --panel_version 1 -r hg19 -t18 --var_class germline -i /ngs-results/RUN20250814Nextseq/AGILENT_GLOBAL -o /ngs-results/RUN20250814Nextseq/AGILENT_GLOBAL --db /ngs-db/"></textarea>

              <div class="d-flex gap-2 mt-2">
                <button id="btnParseCLI" class="btn btn-sm btn-outline-primary">Parseja paràmetres</button>
                <button id="btnClearParams" class="ml-2 btn btn-sm btn-outline-danger">Elimina</button>
              </div>
              <div id="parseMsg" class="small mt-2"></div>
              <hr>

              <div class="inline-chip mb-2">
                <div class="numberCircle">2</div>
                <div><b>Metadata</b></div>
              </div>

              <div class="mb-2">
                <label class="form-label">Nom *</label>
                <input id="p_name" class="form-control" placeholder="">
              </div>
              <div class="mb-2">
                <label class="form-label">Versió</label>
                <input id="p_version" class="form-control" placeholder="p. ex., 1.0.0">
              </div>
              <div class="mb-2">
                <label class="form-label">Intèrpret</label>
                <input id="p_interpreter" class="form-control" placeholder="python3, bash, snakemake...">
                <div id="interpStatus" class="small mt-1"></div>
              </div>
              <div class="mb-2">
                <label class="form-label">Punt d’entrada</label>
                <input id="p_entrypoint" class="form-control" placeholder="/home/udmmp/GC_NGS_PIPELINE/script.py">
                <small class="text-muted">Per a Snakemake, aquest fitxer es passarà com a <code>-s</code>.</small>
              </div>
              <div class="mb-2">
                <label class="form-label">Directori de treball</label>
                <input id="p_workdir" class="form-control" placeholder="/home/udmmp/GC_NGS_PIPELINE">
              </div>
              <div class="mb-2">
                <label class="form-label">Variables d’entorn (JSON)</label>
                <textarea id="p_env" class="form-control" rows="3" placeholder='{"OMP_NUM_THREADS": "8"}'></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Meta (JSON)</label>
                <textarea id="p_meta" class="form-control" rows="3" placeholder='{"owner":"bioinfo"}'></textarea>
              </div>
              <div class="mb-2">
                <label class="form-label">Descripció</label>
                <textarea id="p_description" class="form-control" rows="3" placeholder=""></textarea>
              </div>

              <button id="btnSavePipeline" class="btn btn-primary">Desa canvis</button>
              <div id="savePipelineMsg" class="small mt-2"></div>
            </div>
          </div>
        </div>

        <div class="col-lg-9">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="inline-chip mb-2">
                <div class="numberCircle">3</div>
                <div><b>Paràmetres detectats</b></div>
              </div>
              <div class="mt-2">
                <button id="btnAddParam" class="btn btn-outline-primary btn-sm">Nou paràmetre</button>
              </div>

              <div class="table-responsive mt-3">
                <table class="table table-sm table-borderless align-middle" id="paramsTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width:8%">Categoria</th>
                      <th style="width:10%">I/O Format</th>
                      <th style="width:10%">Nom llarg</th>
                      <th style="width:4%">Nom curt</th>
                      <th style="width:7%">Tipus</th>
                      <th style="width:12%">Default</th>
                      <th style="width:6%">Required</th>
                      <th style="width:6%">Posicional</th>
                      <th style="width:6%">Posició</th>
                      <th style="width:12%">Opcions (comes)</th>
                      <th>Descripció</th>
                      <th style="width:6%"></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PAS 2: Configuracions -->
    <div class="tab-pane fade" id="instances" role="tabpanel" aria-labelledby="instances-tab">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3">Selecciona pipeline</h5>

              <select id="selPipeline" class="form-select"></select>

              <div class="mt-3">
                <label class="form-label">Nom de la configuració</label>
                <input id="cfgName" class="form-control" placeholder="p. ex., default-tumor-lowcov">
              </div>

              <div class="mt-3 d-grid gap-2">
                <button id="btnLoadParams" class="btn btn-outline-secondary">Carrega paràmetres</button>
                <button id="btnRenderCmd" class="btn btn-primary">Genera comanda</button>
                <button id="btnSaveConfig" class="btn btn-success">Desa configuració</button>
              </div>

              <div id="cfgMsg" class="small mt-2"></div>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Paràmetres</h5>
              <div id="paramInputs" class="row g-2"></div>
              <hr>
              <h6 class="mb-2">Previsualització de la comanda</h6>
              <pre id="cmdPreview" class="bg-light p-2 rounded" style="min-height:48px;"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- /tab-content -->
</div> <!-- /container -->

<!-- Safe JSON payloads -->
<script id="seed-json" type="application/json">{{ (seed|default({}))|tojson }}</script>

<script>
  // ---- Backend routes (Jinja) ----
  var API_PARSE_CLI        = {{ url_for('api_parse_cli')        | tojson }};
  var API_SAVE_PIPELINE    = {{ url_for('api_create_pipeline')  | tojson }};
  var API_LIST_PIPELINES   = {{ url_for('api_list_pipelines')   | tojson }};
  var API_GET_PIPELINE_TPL = {{ url_for('api_get_pipeline', pipeline_id=0).replace('/0','/__ID__') | tojson }};
  var API_RENDER           = {{ url_for('api_render_cmd')       | tojson }};
  var API_SAVE_CONFIG_TPL  = {{ url_for('api_create_config', pipeline_id=0).replace('/0','/__ID__') | tojson }};
  var API_CHECK_INTERP     = {{ url_for('api_check_interpreter')| tojson }};
  var API_UPDATE_PIPELINE_TPL = {{ url_for('api_update_pipeline', pipeline_id=0).replace('/0','/__ID__') | tojson }};

  // ---- Page state (SAFE JSON) ----
  var MODE        = {{ mode|default('create')|tojson }};                 // "create" | "edit" | "configure"
  var PIPELINE_ID = {{ pipeline_id|default(None)|tojson }};              // null or int
  var EDITING_ID  = PIPELINE_ID || null;

  // ---- Tiny helpers ----
  function tbody(){ return document.querySelector('#paramsTable tbody'); }
  function el(tag, attrs, html){
    var e=document.createElement(tag||'div'); attrs=attrs||{};
    Object.keys(attrs).forEach(function(k){ if(k==='class') e.className=attrs[k]; else e.setAttribute(k, attrs[k]); });
    if(html!=null) e.innerHTML=html;
    return e;
  }
  function esc(v){ return String(v==null?'':v).replace(/"/g,'&quot;'); }
  function getVal(id){ var x=document.getElementById(id); return x?x.value:""; }
  function tryJSON(s, fallback){ try{ return s?JSON.parse(s):fallback }catch(e){ return fallback } }
  function get(url){ return fetch(url).then(function(r){ return r.json(); }); }
  function post(url, body){ return fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})}).then(function(r){ return r.json(); }); }
  function put(url, body){ return fetch(url, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})}).then(function(r){ return r.json(); }); }


  function handleChange(selectEl) {
  const row = selectEl.closest("tr");
  const formatSelect = row.querySelector(".group_format");

  if (selectEl.value === "Input") {
    selectEl.style.backgroundColor = "lightgreen";
    formatSelect.disabled = false;

    // set options for Input
    formatSelect.innerHTML = `
      <option value=""></option>
      <option value="FASTQ">FASTQ</option>
      <option value="BAM">BAM</option>
      <option value="VCF">VCF</option>
      <option value="BED">BED</option>
      <option value="JSON">JSON</option>
      <option value="YAML">YAML</option>
    `;
  } 
  else if (selectEl.value === "Output") {
    selectEl.style.backgroundColor = "#FFD580"; // light orange
    formatSelect.disabled = false;

    // set options for Output
    formatSelect.innerHTML = `
      <option value=""></option>
      <option value="OUTPUT_DIR">OUTPUT_DIR</option>
    `;
  } 
  else if (selectEl.value === "Param") {
    selectEl.style.backgroundColor = "#d4f1f4"; // light cyan
    formatSelect.disabled = true;  // disable the select
    formatSelect.innerHTML = `<option value=""></option>`; // clear options
  } 
  else {
    // reset if no valid selection
    selectEl.style.backgroundColor = "";
    formatSelect.disabled = false;
    formatSelect.innerHTML = `<option value=""></option>`;
  }
}

   // ---- Params table ----
  function rowTpl(p){
  p = p || {};
  var type = p.type || 'string';
  var defv = (type === 'bool') ? '' : (p.default != null ? p.default : '');


  var group_name = p.group_name || "";
  var group_format = p.group_format || "";

  // define the options
  var groupOptions = ["Param", "Input", "Output"];
  let selectColor = "";
  let disabled = "";

  var optionsHtml = groupOptions.map(function(opt) {
    if (group_name == "Input") {
      selectColor = "lightgreen";
    }
    if (group_name == "Output") {
      selectColor = "#FFD580";
    }
    if (group_name == "Param") {
      selectColor = "#d4f1f4";
      disabled = "disabled";
    }
    return `<option value="${opt}" ${group_name == opt ? "selected" : ""}>${opt}</option>`;
  }).join('');

  var groupFormats = [ "FASTQ", "BAM", "VCF", "BED", "YAML", "JSON"];
  var formatsHtml = groupFormats.map(function(fmt) {
    if(group_name == "Input") {
      return `<option value="${fmt}" ${group_format == fmt ? "selected" : ""}>${fmt}</option>`;
    } 
  }).join('');
  if(group_name == "Output") {
    formatsHtml =  `<option value="OUTPUT_DIR" "selected" : ""}>OUTPUT_DIR</option>`;
  }
  
  return ''+
    '<td>'+
      '<div class="form-group">'+
      `<select class="form-control group_name" style="background-color:${selectColor};" aria-label="Selecciona" onchange="handleChange(this)" >`+
        optionsHtml +
      '</div>'+
    '</td>'+
    '<td>'+
      '<div class="form-group">'+
      `<select class="form-control group_format" aria-label="Selecciona" ${disabled}>`+
        formatsHtml +
      '</div>'+
    '</td>'+
    '<td><input class="form-control form-control-sm name" placeholder="--flag-llarg O nom posicional" value="'+esc(p.name||'')+'"></td>'+
    '<td><input class="form-control form-control-sm short" placeholder="s" value="'+esc(p.short||'')+'"></td>'+
    '<td>'+
      '<select class="form-control type">'+
        ['string','int','float','bool','choice','file','dir'].map(function(t){ return '<option '+(type===t?'selected':'')+'>'+t+'</option>'; }).join('')+
      '</select>'+
    '</td>'+
    '<td><input class="form-control form-control-sm defv" value="'+esc(defv)+'"></td>'+
    '<td class="text-center"><input type="checkbox" class="form-check-input req" '+(p.required?'checked':'')+'></td>'+
    '<td class="text-center"><input type="checkbox" class="form-check-input pos" '+(p.is_positional?'checked':'')+'></td>'+
    '<td><input class="form-control form-control-sm position" type="number" value="'+esc(p.position||'')+'" disabled></td>'+
    '<td><input disabled class="form-control form-control-sm choices" placeholder="a,b,c" value="'+esc((p.choices||[]).join(','))+'"></td>'+
    '<td><input class="form-control form-control-sm desc" value="'+esc(p.description||'')+'"></td>'+
    '<td class="text-center"><button class="btn btn-sm btn-outline-danger del" type="button"><i class="fas fa-trash"></i></button></td>';
}

  function addRow(p){ tbody().appendChild(el('tr', {}, rowTpl(p))); }

  // ---- Interpreter check ----
  function checkInterpreter(name){
    var status = document.getElementById('interpStatus');
    var val = (name||'').trim();
    if(!val){ status.innerHTML = ''; return; }
    get(API_CHECK_INTERP + '?name=' + encodeURIComponent(val))
      .then(function(j){
        if(j.ok && j.found){
          status.innerHTML = '<span class="text-success">Disponible: <code>'+j.path+'</code></span>';
        }else{
          status.innerHTML = '<span class="text-danger">No trobat a <code>PATH</code></span>';
        }
      })
      .catch(function(err){
        status.innerHTML = '<span class="text-warning">No s’ha pogut comprovar: '+esc(err && err.message || err)+'</span>';
      });
  }

  // ---- Configs tab helpers ----
  function refreshPipelineList(){
    return get(API_LIST_PIPELINES).then(function(data){
      var sel = document.getElementById('selPipeline');
      sel.innerHTML = (data.pipelines||[]).map(function(p){
        return '<option value="'+p.id+'">'+esc(p.name)+' ('+esc(p.interpreter||'eina')+')</option>';
      }).join('');
    });
  }

  // ---- Seed hydration ----
  function hydrateFromSeed(seed){
    if(!seed || typeof seed !== 'object') return;
    var meta = seed.pipeline || {};
    if(meta){
      if(meta.suggested_name){ document.getElementById('p_name').value = meta.suggested_name; }
      if(meta.interpreter){ document.getElementById('p_interpreter').value = meta.interpreter; checkInterpreter(meta.interpreter); }
      if(meta.entrypoint){ document.getElementById('p_entrypoint').value = meta.entrypoint; }
    }
    var arr = seed.params || [];
    if(arr.length){
      tbody().innerHTML = '';
      arr.forEach(addRow);
      document.getElementById('parseMsg').innerHTML = '<span class="text-success"> ✓  S’han trobat '+arr.length+' paràmetres (seed).</span>';
    }
  }

  // ---- DOM Ready ----
  document.addEventListener('DOMContentLoaded', function(){

    // Load seed safely from JSON tag
    var seedText = document.getElementById('seed-json').textContent || '{}';
    var SEED = {};
    try { SEED = JSON.parse(seedText); } catch(e) { SEED = {}; }

    // Buttons (left)
    var btnParse = document.getElementById('btnParseCLI');
    var btnClear = document.getElementById('btnClearParams');
    var btnSave  = document.getElementById('btnSavePipeline');
    var pInterp  = document.getElementById('p_interpreter');

    // Buttons (right)
    var btnAdd   = document.getElementById('btnAddParam');
    var btnLoad  = document.getElementById('btnLoadParams');
    var btnRender= document.getElementById('btnRenderCmd');
    var btnCfgSv = document.getElementById('btnSaveConfig');

    // Add param
    btnAdd.addEventListener('click', function(){ addRow({type:'string'}); });

    
    // Clear table
    btnClear.addEventListener('click', function(){
      tbody().innerHTML=''; document.getElementById('parseMsg').textContent='';
    });

    // Remove row (event delegation)
    document.getElementById('paramsTable').addEventListener('click', function(e){
      var btn = e.target.closest('.del'); if(btn){ btn.closest('tr').remove(); }
    });

    // Interpreter blur -> check
    pInterp.addEventListener('blur', function(){ checkInterpreter(getVal('p_interpreter')); });

    // Parse CLI
    btnParse.addEventListener('click', function(){
      var cmd = getVal('cli_text').trim();
      var msg = document.getElementById('parseMsg');
      if(!cmd){ msg.innerHTML = '<span class="text-danger">Si us plau, enganxa una comanda.</span>'; return; }
      msg.textContent = 'Analitzant…';

      post(API_PARSE_CLI, { command: cmd })
        .then(function(data){
          if(!data.ok){ msg.innerHTML = '<span class="text-danger">Error: '+esc(data.error||'desconegut')+'</span>'; return; }

          var meta = data.pipeline || {};
          var suggestedName = meta.suggested_name || '';
          if(!document.getElementById('p_name').value) document.getElementById('p_name').value = suggestedName;
          document.getElementById('p_interpreter').value = meta.interpreter || '';
          document.getElementById('p_entrypoint').value = meta.entrypoint || '';
          checkInterpreter(meta.interpreter || '');

          tbody().innerHTML = '';
          (data.params||[]).forEach(function(p){ addRow(p); });

          msg.innerHTML = '<span class="text-success"> ✓  S’han trobat '+((data.params||[]).length)+' paràmetres.</span>';
        })
        .catch(function(err){
          msg.innerHTML = '<span class="text-danger">Error: '+esc(err && err.message || err)+'</span>';
        });
    });

    // Save (create/update)
    btnSave.addEventListener('click', function(){
      var base = {
        name: getVal('p_name').trim(),
        version: getVal('p_version').trim(),
        interpreter: getVal('p_interpreter').trim(),
        entrypoint: getVal('p_entrypoint').trim(),
        workdir: getVal('p_workdir').trim(),
        env_vars: tryJSON(getVal('p_env'), {}),
        meta: tryJSON(getVal('p_meta'), {})
      };
      var msg = document.getElementById('savePipelineMsg');
      if(!base.name){ msg.innerHTML = '<span class="text-danger">El nom és obligatori.</span>'; return; }

      var params = [];
      tbody().querySelectorAll('tr').forEach(function(tr){
        params.push({
          name: tr.querySelector('.name').value.trim(),
          short: tr.querySelector('.short').value.trim(),
          type: tr.querySelector('.type').value.trim(),
          default: tr.querySelector('.defv').value,
          required: tr.querySelector('.req').checked,
          is_positional: tr.querySelector('.pos').checked,
          position: tr.querySelector('.position').value ? parseInt(tr.querySelector('.position').value,10) : null,
          choices: (tr.querySelector('.choices').value || '').split(',').map(function(s){return s.trim();}).filter(Boolean),
          description: tr.querySelector('.desc').value,
          group_name: tr.querySelector('.group_name').value.trim(),
          group_format: tr.querySelector('.group_format').value.trim(),

        });
      });

      var req = EDITING_ID
        ? put(API_UPDATE_PIPELINE_TPL.replace('/__ID__','/'+EDITING_ID), { pipeline: base, params: params })
        : post(API_SAVE_PIPELINE, { pipeline: base, params: params });

      req.then(function(data){
          if(data.ok){
            msg.innerHTML = '<span class="text-success">Desat. ID = '+data.pipeline_id+'</span>';
            if(!EDITING_ID){ EDITING_ID = data.pipeline_id; }
            refreshPipelineList();
          }else{
            msg.innerHTML = '<span class="text-danger">Error: '+esc(data.error||'desconegut')+'</span>';
          }
        })
        .catch(function(err){
          msg.innerHTML = '<span class="text-danger">Error: '+esc(err && err.message || err)+'</span>';
        });
    });

    // Right tab: Refresh list on load
    refreshPipelineList();

    // Load params for selected pipeline
    btnLoad.addEventListener('click', function(){
      var pid = document.getElementById('selPipeline').value; if(!pid) return;
      var url = API_GET_PIPELINE_TPL.replace('/__ID__','/'+pid);
      get(url).then(function(data){

        console.log(data);

        var params = data.params || [];
        var wrap = document.getElementById('paramInputs'); wrap.innerHTML = '';

        params.sort(function(a,b){
          if(a.is_positional && b.is_positional){ return (a.position||0)-(b.position||0); }
          if(a.is_positional) return -1; if(b.is_positional) return 1;
          return (a.name||'').localeCompare(b.name||'');
        });

        params.forEach(function(p){
          var id = 'pval_'+p.name;
          var inputHTML = '';
          if(p.type === 'bool'){
            inputHTML = '<input type="checkbox" class="form-check-input" id="'+id+'" '+(p.default ? 'checked':'')+'>';
          }else if(p.type === 'choice' && (p.choices||[]).length){
            inputHTML = '<select id="'+id+'" class="form-select form-select-sm">'+
              p.choices.map(function(c){ return '<option '+(String(p.default)===String(c)?'selected':'')+'>'+esc(c)+'</option>'; }).join('')+
              '</select>';
          }else{
            inputHTML = '<input id="'+id+'" class="form-control form-control-sm" value="'+esc(p.default||'')+'">';
          }
          var help = p.description ? '<div class="form-text">'+esc(p.description)+'</div>' : '';
          var col = el('div', {class:'col-md-6'}, ''+
            '<label class="form-label"><b>'+(p.is_positional ? '[pos] ':'')+esc(p.name)+'</b> <small class="text-muted">'+esc(p.type)+(p.required?' *':'')+'</small></label>'+
            inputHTML + help);
          wrap.appendChild(col);
        });
      });
    });

    // Render command
    btnRender.addEventListener('click', function(){
      var pid = document.getElementById('selPipeline').value; if(!pid) return;
      var url = API_GET_PIPELINE_TPL.replace('/__ID__','/'+pid);
      get(url).then(function(data){
        var params = data.params || [];
        var values = {};
        params.forEach(function(p){
          var id = 'pval_'+p.name; var elx = document.getElementById(id); if(!elx) return;
          if(p.type==='bool'){ values[p.name] = elx.checked; } else { values[p.name] = elx.value; }
        });
        return post(API_RENDER, { pipeline_id: parseInt(pid,10), values: values });
      }).then(function(j){
        document.getElementById('cmdPreview').textContent = j && j.ok ? j.command : ('ERROR: '+(j && j.error));
      });
    });

    // Save config
    btnCfgSv.addEventListener('click', function(){
      var pid = document.getElementById('selPipeline').value; if(!pid) return;
      var name = document.getElementById('cfgName').value || 'config';

      var url = API_GET_PIPELINE_TPL.replace('/__ID__','/'+pid);
      get(url).then(function(data){
        var params = data.params || [];
        var values = {};
        params.forEach(function(p){
          var id = 'pval_'+p.name; var elx = document.getElementById(id); if(!elx) return;
          if(p.type==='bool'){ values[p.name] = elx.checked; } else { values[p.name] = elx.value; }
        });
        var saveUrl = API_SAVE_CONFIG_TPL.replace('/__ID__','/'+pid);
        return post(saveUrl, { name: name, values: values });
      }).then(function(j){
        document.getElementById('cfgMsg').innerHTML =
          j && j.ok ? '<span class="text-success">Configuració desada #'+j.config_id+' (hash '+j.hash+')</span>'
                    : '<span class="text-danger">Error: '+esc(j && j.error || 'desconegut')+'</span>';
      });
    });

    // Seed (create mode only)
    if(MODE === 'create'){ hydrateFromSeed(SEED); }

    // Load existing pipeline for edit/configure
    if(PIPELINE_ID){
      var url = API_GET_PIPELINE_TPL.replace('/__ID__','/'+PIPELINE_ID);
      get(url).then(function(data){
        var p = data.pipeline || {};
        var params = data.params || [];
        // meta
        document.getElementById('p_name').value        = p.name || document.getElementById('p_name').value || '';
        document.getElementById('p_version').value     = p.version || '';
        document.getElementById('p_interpreter').value = p.interpreter || '';
        document.getElementById('p_entrypoint').value  = p.entrypoint || '';
        document.getElementById('p_workdir').value     = p.workdir || '';
        document.getElementById('p_env').value         = JSON.stringify(p.env_vars || {}, null, 2);
        document.getElementById('p_meta').value        = JSON.stringify(p.meta || {}, null, 2);
        checkInterpreter(p.interpreter || '');
        // params table
        tbody().innerHTML = '';
        params.forEach(addRow);

        // configure mode -> switch tab and preselect
        if(MODE === 'configure'){
          var tabBtn = document.getElementById('instances-tab');
          try{
            if(window.bootstrap && bootstrap.Tab){ new bootstrap.Tab(tabBtn).show(); }
            else{
              document.querySelector('#define').classList.remove('show','active');
              document.querySelector('#instances').classList.add('show','active');
              document.getElementById('define-tab').classList.remove('active');
              tabBtn.classList.add('active');
            }
          }catch(e){}
          refreshPipelineList().then(function(){
            document.getElementById('selPipeline').value = String(PIPELINE_ID);
            document.getElementById('btnLoadParams').click();
          });
        }
      });
    }

  }); // DOMContentLoaded
</script>
{% endblock body %}
