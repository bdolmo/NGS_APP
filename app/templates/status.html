{% extends "base.html" %}

{% block body %}

<!-- Modal: Change Status -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeStatusModalLabel">Canvia l'Status del Job</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="changeStatusForm">
          <div class="mb-3">
            <label for="newStatusInput" class="form-label">New Status</label>
            <select class="form-select" id="newStatusInput" required>
              <option value="queued">Queued</option>
              <option value="started">Started</option>
              <option value="running">Running</option>
              <option value="finished">Finished</option>
              <option value="failed">Failed</option>
              <option value="stopped">Stopped</option>
            </select>
          </div>
          <input type="hidden" id="jobIdInput">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel·la</button>
        <button type="button" id="saveStatusButton" class="btn btn-primary">Desa canvis</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Config -->
<div class="modal fade" id="configModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" style="min-width:1500px">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><b>Configuració d'anàlisi</b></h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body"><!-- filled by JS --></div>
      <div class="modal-footer"></div>
    </div>
  </div>
</div>

<div class="container-fluid py-4 rounded mb-4 mt-4 bg-light" style="margin:0 auto; width:100%;">
  <div style="margin:0 auto; width:90%;">

    <!-- Counters -->
    <div class="row text-center mb-4">
      <div class="col-md-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title"><i class="fas fa-tasks"></i> Total Analisis</h5>
            <h2 class="card-text">{{ status_dict['Total jobs'] if status_dict else 0 }}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title"><i style="color:rgb(114, 170, 114);" class="fas fa-check-circle"></i> Completats</h5>
            <h2 class="card-text">{{ status_dict['Completed'] if status_dict else 0 }}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title"><i style="color:rgb(116, 208, 224);" class="fas fa-play-circle"></i> En progrés</h5>
            <h2 class="card-text">{{ status_dict['Running'] if status_dict else 0 }}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title"><i style="color:rgb(250, 135, 135);" class="fas fa-times-circle"></i> Fallits</h5>
            <h2 class="card-text">{{ status_dict['Failed'] if status_dict else 0 }}</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Flash messages -->
    <div class="d-flex justify-content-center mt-3">
      <div class="row">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show ml-3" role="alert">
            <span>{{ message }}</span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <br>
          </div>
          {% endfor %}
        {% endif %}
        {% endwith %}
      </div>
    </div>

    <!-- Controls -->
    <div class="row mb-4">
      <div class="col-md-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Cerca">
      </div>
      <div class="col-md-3">
        <select id="statusFilter" class="form-control">
          <option value="">Filtra per Status</option>
          <option value="queued">Queued</option>
          <option value="finished">Finished</option>
          <option value="started">Started</option>
          <option value="running">Running</option>
          <option value="failed">Failed</option>
          <option value="stopped">Stopped</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="sortFilter" class="form-control">
          <option value="">Ordena per</option>
          <option value="date" selected>Data</option>
          <option value="job_id">Nom Job</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary" onclick="applyFilters()">Aplica</button>
      </div>
    </div>

    <!-- Cards container (filled by JS) -->
    <div id="jobsList" class="row"></div>

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-1">
      <nav>
        <ul id="pagination" class="pagination"></ul>
      </nav>
    </div>
  </div>
</div>

<!-- URL templates / flags from Flask -->
<script>
  const SHOW_SOMATIC_URL = "{{ url_for('show_run_details', run_id='__RUN__') }}";
  const SHOW_GERMLINE_URL = "{{ url_for('show_compendium_run', run_id='__RUN__') }}";
  const REMOVE_URL        = "{{ url_for('remove_job', queue_id='__Q__', job_id='__RUN__', panel='__P__') }}";
  const STOP_URL          = "{{ url_for('stop_job', queue_id='__Q__') }}";
  const DOWNLOAD_LOG_URL  = "{{ url_for('download_log', job_id='__RUN__') }}";
  const IS_ADMIN          = {{ 'true' if session.get('user') == 'admin' else 'false' }};
  const API_STOP_JOB      = "{{ url_for('api_stop_job', queue_id='__Q__') }}";

</script>

<!-- Main logic -->
<script>
let state = {
  page: 1,
  per_page: 9,
  search: "",
  status: "",
  sort: "date",
  order: "desc",
};

function readControls() {
  state.search = (document.getElementById('searchInput').value || '').trim();
  state.status = (document.getElementById('statusFilter').value || '').trim();
  const sort   = (document.getElementById('sortFilter').value || '').trim();
  state.sort   = sort || 'date';
  state.order  = (state.sort === 'job_id') ? 'asc' : 'desc';
}

function setCounters(s) {
  if (!s) return;
  const boxes = document.querySelectorAll('.row.text-center.mb-4 .card .card-body h2.card-text');
  if (boxes.length >= 4) {
    boxes[0].textContent = s["Total jobs"] ?? 0;
    boxes[1].textContent = s["Completed"] ?? 0;
    boxes[2].textContent = s["Running"] ?? 0;
    boxes[3].textContent = s["Failed"] ?? 0;
  }
}

function statusStyles(status) {
  switch ((status || '').toLowerCase()) {
    case 'queued':    return { border:'#6c757d', bg:'#eef0f1' };
    case 'finished':  return { border:'#28a745', bg:'' };
    case 'started':   return { border:'blue',    bg:'' };
    case 'running':   return { border:'blue', bg:'' };
    case 'failed':    return { border:'#dc3545', bg:'' };
    case 'stopped':   return { border:'#ffc107', bg:'' };
    case 'deferred':  return { border:'#8a2be2', bg:'' }; // purple
    case 'scheduled': return { border:'#ff7f0e', bg:'' }; // orange
    default:          return { border:'#000',    bg:'' };
  }
}


function analysisMeta(analysis) {
  const a = (analysis || '').toLowerCase();
  const germ = a === 'germline';
  return { label: germ ? 'GERMINAL' : 'SOMÀTIC', color: germ ? '#0047AB' : '#E30B5C' };
}

function jobLink(job) {
  const a = (job.Analysis || '').toLowerCase();
  const s = (job.Status || '').toLowerCase();
  if (['failed','queued','started','stopped'].includes(s)) return null;
  if (a === 'germline') return SHOW_GERMLINE_URL.replace('__RUN__', job.Job_id);
  return SHOW_SOMATIC_URL.replace('__RUN__', job.Job_id);
}


function renderCard(job) {
  const styles = statusStyles(job.Status);
  const {label, color} = analysisMeta(job.Analysis);
  const link = jobLink(job);

  const removeHref = REMOVE_URL
    .replace('__Q__', encodeURIComponent(job.Queue_id || ''))
    .replace('__RUN__', encodeURIComponent(job.Job_id || ''))
    .replace('__P__', encodeURIComponent(job.Panel || ''));

  const dlHref   = DOWNLOAD_LOG_URL.replace('__RUN__', encodeURIComponent(job.Job_id || ''));

  const titleHtml = link ? `<a href="${link}"><b>${job.Job_id}</b></a>` : `<b>${job.Job_id}</b>`;

  const adminBtn = IS_ADMIN ? `
    <button class="btn btn-sm btn-outline-secondary change-status-btn"
            data-job-id="${job.Job_id}" data-current-status="${job.Status}">
      <i class="fas fa-edit"></i> Canvia status
    </button>` : ``;

  const logBtns = job.HasLog ? `
    <button class="btn btn-sm btn-outline-secondary">
      <a href="${dlHref}" style="text-decoration:none;color:inherit;">
        <i class="fas fa-download"></i> Log
      </a>
    </button>
    <button class="btn btn-sm btn-outline-info toggle-log-btn"
            data-job-id="${job.Job_id}"
            data-panel="${job.Panel || ''}"
            data-queue-id="${job.Queue_id || ''}">
      <i class="fas fa-eye"></i> Mostra log
    </button>
    <p class="log-message" style="display:none;margin-top:5px;"></p>
  ` : ``;

  const stoppable = ['started','running','queued'].includes((job.Status||'').toLowerCase());
  const stopBtn = (stoppable && job.Queue_id) ? `
    <button class="btn btn-link p-0 stop-job-btn"
            title="Atura job"
            data-queue-id="${job.Queue_id}"
            data-job-id="${job.Job_id}">
      <i class="fas fa-stop-circle text-primary"></i>
    </button>` : ``;

  return `
  <div class="col-md-4 job-card-container">
    <div class="card mb-3 shadow-sm job-card"
         data-status="${job.Status}" data-job-id="${job.Job_id}"
         data-panel="${job.Panel}" data-queue-id="${job.Queue_id}"
         data-analysis="${job.Analysis}" data-date="${job.Date}">
      <div class="card-body ${(['started','running'].includes((job.Status||'').toLowerCase())) ? 'animated-div' : ''}"
           style="border-left:5px solid ${styles.border};${styles.bg ? `background-color:${styles.bg};` : ''}">
        <h6 class="mb-0">
          ${titleHtml}
          <span style="float:right;font-size:12px;color:${color}"><b>${label}</b></span>
        </h6>
        <hr style="margin:0px">
        <div class="row">
          <div class="col-10">
            <p style="margin:1px;" class="card-text"><b>Date:</b> ${job.Date || ''}</p>
            <p style="margin:1px;" class="card-text"><b>Panel:</b> ${job.Panel || ''}</p>
            <p style="margin:1px;" class="card-text"><b>N Samples:</b> ${job.Samples ?? ''}</p>
            ${logBtns}
            ${cfgBtnHTML(job)}
          </div>
          <div class="col-2">
            <a href="${removeHref}" role="button"
               onclick="return confirm('Segur que vols eliminar aquest RUN?');">
              <i class="fas fa-trash text-danger"></i>
            </a>
            ${stopBtn}
            ${adminBtn}
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function cfgBtnHTML(job){
  return job.HasConfig ? `
    <button class="btn btn-sm btn-outline-primary view-config-btn" data-job-id="${job.Job_id}">
      <i class="fas fa-cogs"></i> Conf. Anàlisi
    </button>` : ``;
}

// Stop a job (delegation)
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.stop-job-btn');
  if (!btn) return;

  const queueId = btn.getAttribute('data-queue-id');
  const jobId   = btn.getAttribute('data-job-id') || '';
  if (!queueId) return;

  if (!confirm(`Vols aturar el job ${jobId || queueId}?`)) return;

  try {
    const url = API_STOP_JOB.replace('__Q__', encodeURIComponent(queueId));
    const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
    const j = await r.json();
    if (!j.ok) {
      alert('No s’ha pogut aturar: ' + (j.error || 'Error desconegut'));
      return;
    }
    // Refresh just the list
    fetchJobs(false);
  } catch (err) {
    alert('Error de xarxa al parar el job: ' + err.message);
  }
});




function renderJobs(jobs) {
  const list = document.getElementById('jobsList');
  list.innerHTML = (jobs || []).map(renderCard).join('');
}

function renderPagination(page, pages, total) {
  const ul = document.getElementById('pagination');
  const prevDisabled = (page <= 1) ? 'disabled' : '';
  const nextDisabled = (page >= pages) ? 'disabled' : '';

  let inner = `
    <li class="page-item ${prevDisabled}">
      <a class="page-link" href="#" data-page="${page-1}">Previ</a>
    </li>`;

  const maxBtns = 7;
  let start = Math.max(1, page - 3);
  let end   = Math.min(pages, start + maxBtns - 1);
  start = Math.max(1, Math.min(start, end - maxBtns + 1));

  for (let p = start; p <= end; p++) {
    inner += `<li class="page-item ${p===page?'active':''}">
      <a class="page-link" href="#" data-page="${p}">${p}</a>
    </li>`;
  }

  inner += `
    <li class="page-item ${nextDisabled}">
      <a class="page-link" href="#" data-page="${page+1}">Següent</a>
    </li>`;

  ul.innerHTML = inner;
}

async function fetchJobs(resetPage=true) {
  if (resetPage) state.page = 1;
  readControls();

  const params = new URLSearchParams({
    page: state.page, per_page: state.per_page,
    search: state.search, status: state.status,
    sort: state.sort, order: state.order
  });
  const res = await fetch(`/api/jobs?${params.toString()}`);
  const data = await res.json();

  renderJobs(data.jobs || []);
  renderPagination(data.page || 1, data.pages || 1, data.total || 0);
  setCounters(data.status_summary);
}

function applyFilters() {
  fetchJobs(true);
}

// Pagination click (delegation)
document.addEventListener('click', (e) => {
  const a = e.target.closest('#pagination a.page-link');
  if (!a) return;
  e.preventDefault();
  const p = parseInt(a.dataset.page, 10);
  if (isNaN(p) || p < 1) return;
  state.page = p;
  fetchJobs(false);
});


// replace your existing toggle listener with this:
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.toggle-log-btn');
  if (!btn) return;

  const card = btn.closest('.job-card');
  if (!card) return;

  const p = card.querySelector('.log-message');
  const jobId   = btn.getAttribute('data-job-id');
  const panel   = btn.getAttribute('data-panel')   || '';
  const queueId = btn.getAttribute('data-queue-id')|| '';

  if (p.style.display === 'none' || !p.textContent.trim()) {
    if (!p.textContent.trim()) {
      try {
        const qs = new URLSearchParams({ panel, queue_id: queueId });
        const r = await fetch(`/api/job/${encodeURIComponent(jobId)}/logline?` + qs.toString());
        const j = await r.json();
        p.textContent = j.last_line || '(sense dades)';
      } catch {
        p.textContent = '(no disponible)';
      }
    }
    p.style.display = 'block';
    btn.innerHTML = `<i class="fas fa-eye-slash"></i> Amaga log`;
  } else {
    p.style.display = 'none';
    btn.innerHTML = `<i class="fas fa-eye"></i> Mostra log`;
  }
});


// Change Status modal open (delegation)
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.change-status-btn');
  if (!btn) return;
  const jobId = btn.getAttribute('data-job-id');
  const currentStatus = btn.getAttribute('data-current-status');
  document.getElementById('jobIdInput').value = jobId;
  document.getElementById('newStatusInput').value = currentStatus;
  new bootstrap.Modal(document.getElementById('changeStatusModal')).show();
});

// Save new status
document.getElementById('saveStatusButton')?.addEventListener('click', async () => {
  const jobId = document.getElementById('jobIdInput').value;
  const newStatus = document.getElementById('newStatusInput').value;
  try {
    const res = await fetch(`/change_status`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ job_id: jobId, new_status: newStatus })
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Unknown error');
    fetchJobs(false);
    bootstrap.Modal.getInstance(document.getElementById('changeStatusModal')).hide();
  } catch (err) {
    alert('Failed to update status: ' + err.message);
  }
});

// Toggle log (lazy)
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.toggle-log-btn');
  if (!btn) return;
  const jobId = btn.getAttribute('data-job-id');
  const p = document.getElementById(`log-msg-${jobId}`);
  if (p.style.display === 'none' || !p.textContent.trim()) {
    if (!p.textContent.trim()) {
      try {
        const r = await fetch(`/api/job/${encodeURIComponent(jobId)}/logline`);
        const j = await r.json();
        p.textContent = j.last_line || '(sense dades)';
      } catch {
        p.textContent = '(no disponible)';
      }
    }
    p.style.display = 'block';
    btn.innerHTML = `<i class="fas fa-eye-slash"></i> Amaga log`;
  } else {
    p.style.display = 'none';
    btn.innerHTML = `<i class="fas fa-eye"></i> Mostra log`;
  }
});

// View config (lazy)
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.view-config-btn');
  if (!btn) return;
  const jobId = btn.getAttribute('data-job-id');
  const modalEl   = document.getElementById('configModal');
  const modalBody = modalEl.querySelector('.modal-body');
  const bsModal   = new bootstrap.Modal(modalEl);

  try {
    const r = await fetch(`/api/job/${encodeURIComponent(jobId)}/config`);
    const j = await r.json();
    const cfgs  = j.config || {};
    let cmd_str = (j.cmd || '').replace(/yaml$/i, '').trim();

    let navHtml = '<ul class="nav flex-column">';
    let contentHtml = '';
    navHtml += `<li class="nav-item"><a class="nav-link" href="#cmd-${jobId}">Pipeline CMD</a></li>`;
    contentHtml += `
      <div id="cmd-${jobId}" class="mb-4">
        <h5><b>Pipeline command:</b></h5>
        <p class="log-message">${cmd_str}</p>
      </div><hr style="border:1px solid darkgrey;">`;

    const names = Object.keys(cfgs);
    names.forEach(name => {
      const sectionId = `cfg-${jobId}-${name}`;
      let pretty = name.replace(/_/g, ' ').replace(/yaml$/i, '').trim();
      if (pretty === 'ann')    pretty = 'Annotacions';
      if (pretty === 'config') pretty = 'Configuració';
      if (pretty === 'bin')    pretty = 'Binaris';
      if (pretty === 'ref')    pretty = 'Referències';
      if (pretty === 'docker') pretty = 'Docker';

      navHtml += `<li class="nav-item"><a class="nav-link" href="#${sectionId}">${pretty}</a></li>`;
      contentHtml += `<div id="${sectionId}" class="mb-4"><h5><b>${pretty}</b></h5>`;

      const content = cfgs[name];
      if (content && typeof content === 'object') {
        for (const key in content) {
          const sub = content[key];
          if (Array.isArray(sub)) {
            if (sub.length && typeof sub[0] === 'object') {
              let headers = Object.keys(sub[0]);
              const skip = ['key','dirname','resurce_name','hg19','hg38'];
              headers = headers.filter(h => !skip.includes(h));
              const rIdx = headers.indexOf('resource_name');
              if (rIdx > -1) { headers.splice(rIdx,1); headers.unshift('resource_name'); }
              contentHtml += `
                <h6><b>${capitalizeFirst(key)}</b></h6>
                <table class="table table-striped table-bordered">
                  <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
                  <tbody>${sub.map(item=>`<tr>${
                    headers.map(h=>{
                      let v = item[h];
                      if (Array.isArray(v)) v = v.join(', ');
                      return `<td style="max-width:100px;overflow-wrap:break-word;">${v ?? ''}</td>`;
                    }).join('')
                  }</tr>`).join('')}</tbody>
                </table><hr style="border:1px solid darkgrey;">`;
            } else if (sub.length) {
              contentHtml += `<h6><b>${capitalizeFirst(key)}</b></h6><ul>${
                sub.map(el=>`<li>${el}</li>`).join('')
              }</ul>`;
            }
          } else if (typeof sub === 'object') {
            const entries = Object.entries(sub);
            if (!entries.length) continue;
            contentHtml += `<h6><b>${capitalizeFirst(key)}</b></h6>
              <table class="table table-striped table-bordered"><tbody>${
                entries.map(([k,v])=>{
                  if (key === 'predictors' && typeof v === 'string') {
                    const v_list = v.split(',').map(s=>s.trim()).filter(Boolean);
                    let info = 'info';
                    if (k==='missense_predictors') info='danger';
                    if (k==='splicing_predictors') info='warning';
                    const pills = v_list.map(x=>`<span class="badge bg-${info}" style="color:white;">${x}</span>`).join(' ');
                    return `<tr><td style="max-width:100px;overflow-wrap:break-word;">${k}</td><td>${pills}</td></tr>`;
                  }
                  if (Array.isArray(v)) v = v.join(', ');
                  return `<tr><td style="max-width:100px;overflow-wrap:break-word;">${k}</td><td>${v ?? ''}</td></tr>`;
                }).join('')
              }</tbody></table>`;
          } else if ((sub ?? '').toString().length) {
            contentHtml += `<p>${sub}</p>`;
          }
        }
      } else {
        contentHtml += `<p><em>No data for ${jobId}/${name}.</em></p>`;
      }
      contentHtml += `</div>`;
    });

    navHtml += '</ul>';
    modalBody.innerHTML = `
      <div class="row">
        <nav class="col-1 border-end pe-3" style="max-height:75vh;overflow-y:auto;">${navHtml}</nav>
        <div class="col-11" style="max-height:75vh;overflow-y:auto;">${contentHtml}</div>
      </div>`;
    bsModal.show();
  } catch (err) {
    alert('No s’ha pogut carregar la configuració.');
  }
});

function capitalizeFirst(str) {
  if (!str) return '';
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// Controls wiring + auto refresh
document.getElementById('searchInput')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') applyFilters();
});
document.getElementById('statusFilter')?.addEventListener('change', () => applyFilters());
document.getElementById('sortFilter')?.addEventListener('change', () => applyFilters());
window.onload = () => fetchJobs(true);
setInterval(() => fetchJobs(false), 60000); // refresh data every 60s
</script>

{% endblock body %}
