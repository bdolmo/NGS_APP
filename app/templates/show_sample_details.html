{% extends "base.html" %}

{% block body %}

<div id="edit_sample" class="modal fade">
  <!-- <form action="" method="POST" enctype="multipart/form-data" id="update_petition"> -->
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color:rgb(248, 248, 248);">
          <h4 class="modal-title" id="edit_petition_name">Dades demogràfiques</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row mt-3">
            <div class="col-sm">
              <h6><b>Lab ID</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_lab_id" value="" type="text" name="modal_edit_lab_id" class="form-control" placeholder="">
              </div>
            </div>

            <div class="col-sm">
              <h6><b>Nº Petició</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_modulab_id" value="" type="text" name="modal_edit_modulab_id" class="form-control" placeholder="">
              </div>
            </div>

            <div class="col-sm">
              <h6><b>HC</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_ext2_id" value="" type="text" name="modal_edit_ext2_id" class="form-control" placeholder="">
              </div>
            </div>
            <div class="col-sm">
              <h6><b>CIP</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_ext3_id" value="" type="text" name="modal_edit_ext3_id" class="form-control" placeholder="">
              </div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-sm">
              <h6><b>Edat</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_age" value="" type="text" name="modal_edit_age" class="form-control" placeholder="">
              </div>
            </div>
            <div class="col-sm">
              <h6><b>Sexe</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_sex" value="" type="text" name="modal_edit_sex" class="form-control" placeholder="">
              </div>
            </div>
            <div class="col-sm ">
              <h6><b>Metge sol·licitant</b></h6>
              <input id="modal_edit_physician_name" type="text" name="modal_edit_physician_name" class="form-control" >
            </div>
            <div class="col-sm ">
              <h6><b>Hospital</b></h6>
              <input id="modal_edit_hospital" type="text" name="modal_edit_hospital" class="form-control" >
            </div>

          </div>

          <div class="row mt-3">
            <div class="col-3">
              <h6><b>Origen tumoral</b></h6>
              <input id="modal_edit_tumor_origin" type="text" name="modal_edit_tumor_origin" class="form-control" >
            </div>
            <div class="col-3 ">
              <h6><b>Bloc AP</b></h6>
              <input id="modal_edit_sample_block" type="text" name="modal_edit_sample_block" class="form-control" >
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-sm">
              <h6><b>Tipus de mostra</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_sample_type" value="" type="text" name="modal_edit_sample_type" class="form-control" placeholder="">
              </div>
            </div>
            <div class="col-sm ">
              <h6><b>%Tumoral</b></h6>
              <select class="custom-select" name="modal_edit_tumoral_pct" id="modal_edit_tumoral_pct">
                {% for n in range(0, 100, 5) %}
                <option value="{{n}}">{{n}}</option>
                {% endfor %}
              </select>
            </div>


            <div class="col-sm ">
              <h6><b>Servei sol·licitant</b></h6>
              <input id="modal_edit_service" type="text" name="modal_edit_service" class="form-control" >
            </div>

          </div>

          <div class="row mt-3">
            <div class="col-sm">
              <h6><b>Data biòpsia original</b> <small>(MM/DD/YYYY)</small></h6>
              <div class="form-group">
                <div id="datepicker" data-provide="datepicker">
                  <input class="form-control" name="Date" type="date" value="" id="modal_edit_biopsy_date">
                  <div class="input-group-addon">
                      <span class="glyphicon glyphicon-th"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm">
              <h6><b>Data de rebuda</b> <small>(MM/DD/YYYY)</small></h6>
              <div class="form-group">
                <div id="datepicker" data-provide="datepicker">
                  <input class="form-control" name="Date" type="date" value="" id="modal_edit_recieved_date">
                  <div class="input-group-addon">
                      <span class="glyphicon glyphicon-th"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-center align-items-center mt-1 mb-2">
          <button class="btn btn-primary mt-2 mb-2" style="width:15%;" type="submit" id="change_sample_info_button">Desa</button>
        </div>
      </div>
    </div>
  <!-- </form> -->
</div>

<div class="modal fade bd-example-modal-xl" id="show_igv" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color:rgb(248, 248, 248);">
        <h4 class="modal-title" id=""><b>IGV</b> </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="margin:0 auto;width:100%;height:100%">
          <div id='igvDiv' style="width:100%;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="tier_modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header" style="background-color:rgb(248, 248, 248);">
        <h4 class="modal-title" id="tier_title">Modifica la Tier </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="">
        <div id='tierDiv' style="width:100%;">
          <input type="radio" id="tier_1" name="change_tier[]" value="1">
          <label for="tier_1">Tier 1</label><br>
          <input type="radio" id="tier_2" name="change_tier[]" value="2">
          <label for="tier_2">Tier 2</label><br>
          <input type="radio" id="tier_3" name="change_tier[]" value="3">
          <label for="tier_3">Tier 3</label><br>
          <input type="radio" id="no_tier" name="change_tier[]" value="4">
          <label for="no_tier">No tier</label><br>
          <p id="modal_var_id" style="display:none;"></p>
        </div>
        <hr>
        <button id="change_tier_button" style="margin:0px auto;" class="btn btn-primary btn-sm">Accepta</button>
      </div>
    </div>
  </div>
</div>

<div id="main_flex" class="d-flex" >

<!-- Sidebar -->
<div class="bg-light border-right vh-100" id="sidebar-wrapper"style="position:fixed;width:15%;">
  <div class="list-group list-group-flush">
    <div href="#" class="list-group-item list-group-item-action" style="background-color:#d9f7f7;">
      
      <div style="font-size:24px;"><img class="card-img rounded-circle" style="width:32px;height:32px;font-size:28px;" src="{{ session['avatar'] }}">
    {{ session["username"] }}</div>
    <i style="color:green;" class="fas fa-circle"></i><span style="font-size:13px;"> Online</span>
    <!-- <p style="font-size:13px;"><b>Últim accés:</b>  </p> -->
   </div>
    <div href="#" class="list-group-item list-group-item-action bg-light">
      <div class="row">
        <div class="col">
          <i class="fas fa-external-link-alt"> </i><b> Últims 5 runs</b>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <ul>
          {% for job in All_jobs %}
            <li> <a href="{{ url_for('show_run_details', run_id=job.Job_id) }}"><b>{{ job.Job_id }}</b></a></li>
          {% endfor %}
         </ul>
        </div>
     </div>
    </div>

    <div href="#" class="list-group-item list-group-item-action bg-light">
      <div class="row">
        <div class="col">
          <i class="fas fa-list"> </i> <b>Últimes 10 accions</b>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <ul>
          {% for change in All_changes_dict %}
            {% if All_changes_dict[change]['action_data']['action_json']['origin_action'] == "Create report" %}
              {% set colour = "" %}
            {% endif %}
            {% if All_changes_dict[change]['action_data']['action_json']['origin_action'] == "delete" %}
              {% set colour = "red" %}
            {% endif %}

            {% if 'redo' in All_changes_dict[change]['action_data']['action_json'] %}
              {% if All_changes_dict[change]['action_data']['action_json']['redo'] == True %}

              <li>
                <a style="word-wrap:break-word;colour:{{colour}};">{{ All_changes_dict[change]['action_name'] }}
                  <a href="{{ url_for('redo_action', action_id=change, run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, active="General")}}" role="button">
                    <span class="badge badge-secondary"><i class="fas fa-redo"></i></span>
                  </a>
                </a>
              </li>
              {% else %}
              <li>
                <a style="word-wrap:break-word;color:{{colour}};">{{ All_changes_dict[change]['action_name'] }}
                 <a href="{{ url_for('redo_action', action_id=change, run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, active="General")}}" role="button"></a>
               </a>
              </li>
              {% endif %}
            {% else %}
              <li>
                <a style="word-wrap:break-word;">{{ All_changes_dict[change]['action_name'] }}
                  <a href="{{ url_for('redo_action', action_id=change, run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, active="General")}}" role="button">
                    <span class="badge badge-secondary"><i class="fas fa-redo"></i></span>
                  </a>
                </a>
              </li>
            {% endif %}
          {% endfor %}
         </ul>
        </div>
     </div>
    </div>
  </div>
</div>

<div class="container-fluid rounded" style="margin-right:90px;background-color:white; width:80%">

  <nav aria-label="breadcrumb ">
    <ol class="breadcrumb mt-3">
      <li class="breadcrumb-item"><a href="{{ url_for('status') }}">Resultats</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('show_run_details', run_id=sample_info.run_id) }}" id="run_id_tag">{{ sample_info.run_id }}</a></li>
      <li class="breadcrumb-item active" aria-current="page"><h5>{{ sample_info.lab_id }}</h5></li>
    </ol>
  </nav>

  <ul class="nav nav-tabs">
    <li class="nav-item">
      {% if active == "General" %}
        <a class="nav-link active" id="General-tab" data-toggle="tab" href="#General">General</a>
      {% else %}
        <a class="nav-link" id="General-tab" data-toggle="tab" href="#General">General</a>
      {% endif %}
    </li>
    <li class="nav-item">
      <a class="nav-link" id="QC-tab" data-toggle="tab" href="#QC">QC</a>
    </li>

    <li class="nav-item">
      <a class="nav-link" id="Lost_Exons-tab" data-toggle="tab" href="#Lost_Exons">Exons no coberts</a>
    </li>

    <li class="nav-item">
      {% if active == "Therapeutic" %}
        <a class="nav-link active" id="Therapeutic-tab" data-toggle="tab" href="#Therapeutic" >Variants d'alt impacte</a>
      {% else %}
        <a class="nav-link" id="Therapeutic-tab" data-toggle="tab" href="#Therapeutic">Variants d'alt impacte</a>
      {% endif %}
    </li>

    <li class="nav-item">
      {% if active == "Rare" %}
        <a class="nav-link active" id="Rare-tab" data-toggle="tab" href="#Rare">Variants VUS</a>
      {% else %}
        <a class="nav-link" id="Rare-tab" data-toggle="tab" href="#Rare">Variants VUS</a>
      {% endif %}
    </li>
    <li class="nav-item">
      <a class="nav-link" id="CNA-tab" data-toggle="tab" href="#CNA">CNA</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="Fusion-tab" data-toggle="tab" href="#Fusions">Fusions</a>
    </li>
  </ul>

  <div class="tab-content">
    {% if active == "General" %}
    <div class="tab-pane fade show active" id="General" role="tabpanel" aria-labelledby="General-tab">
    {% else %}
    <div class="tab-pane fade" id="General" role="tabpanel" aria-labelledby="General-tab">
    {% endif %}
    <div class="card card-body border-0 mt-2" style="outline-bottom: 1px solid grey;background-color:white;">
      <div class="row" style="font-size:16px;">
        <div class="col-4">
          <h5><i class="fas fa-id-card"></i> Pacient</h5>
          <hr style="margin:0px;">
          <div class="row">
            <div class="col">

              <div style="margin:0px;">
                <b style="display:inline-block;">Petició: </b>
                <div style="display:inline-block;margin:0px;" id="edit_modulab_id"> {{ sample_info.modulab_id }}</div>
              </div>

              <div style="margin:0px;">
                <b style="display:inline-block;">Lab ID: </b>
                <div style="display:inline-block;" id="edit_lab_id">{{ sample_info.lab_id }}</div>
              </div>

              <div style="display:inline-block;margin:0px;">
                <b style="display:inline-block;">Edat: </b>
                <div style="display:inline-block;" id="edit_age">{{ sample_info.Age|int }} </div>
              </div>

            </div>
            <div class="col">
              <div style="margin:0px;">
                <b style="display:inline-block;">CIP: </b>
                <div style="display:inline-block;margin:0px;" id="edit_ext3_id"> {{ sample_info.ext3_id }}</div>
              </div>
              <div style="margin:0px;">
                <b style="display:inline-block;">Núm. HC: </b>
                <div style="display:inline-block;margin:0px;" id="edit_ext2_id"> {{ sample_info.ext2_id }}</div>
              </div>
              <div style="display:inline-block;margin:0px;">
                <b style="display:inline-block;">Sexe: </b>
                <div style="display:inline-block;" id="edit_sex">{{ sample_info.Sex }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-4">
          <h5><i class="fas fa-vials"></i> Mostra</h5>
          <hr style="margin:0px;">
          <div class="row">
            <div class="col">
              <div style="display:inline-block;margin:0px;">
                <b>Tipus de mostra: </b>
                <div style="display:inline-block;" id="edit_sample_type">bloc de parafina</div>
              </div>
              <div style="margin:0px;">
                <b>Data de rebuda: </b>

                {% set petition_date = "." %}
                {% if petition_info.Petition_date %}
                  {% set petition_date = petition_info.Petition_date %}
                {% else %}
                  {% set petition_date = sample_info.petition_date %}
                {% endif %}

                <div style="display:inline-block;" id="edit_recieved_date"> {{ petition_date }}</div>
              </div>
              <div style="display:inline-block;margin:0px;"> 
                <b>Bloc AP: </b>

                  {% set sample_block = "." %}
                  {% if petition_info.Sample_block %}
                    {% set sample_block = petition_info.Sample_block %}
                  {% else %}
                    {% set sample_block = sample_info.sample_block %}
                  {% endif %}

                <div style="display:inline-block;" id="edit_sample_block"> {{ sample_block }}</div>  
              </div>

            </div>
            <div class="col">
              <div style="display:inline-block;margin:0px;"> 
                <b>Origen tumoral: </b>

                {% set tumour_origin = "." %}
                {% if petition_info.Tumour_origin %}
                  {% set tumour_origin = petition_info.Tumour_origin %}
                {% else %}
                  {% set tumour_origin = sample_info.tumor_origin %}
                {% endif %}

                <div style="display:inline-block;" id="edit_tumor_origin"> {{ tumour_origin }}</div>  
              </div>
              <div style="display:inline-block;margin:0px;"> 
                <b>Puresa tumoral: </b>

                {% set tumour_purity = "." %}
                {% if petition_info.Tumour_pct %}
                  {% set tumour_purity = petition_info.Tumour_pct %}
                {% else %}
                  {% set tumour_purity = sample_info.tumour_purity %}
                {% endif %}

                <div style="display:inline-block;" id="edit_tumoral_pct"> {{ tumour_purity}}%</div>  
              </div>
              <div style="display:inline-block;margin:0px;"> 
                <b>Data biòpsia: </b>

                {% set biopsy_date = "." %}
                {% if petition_info.Date_original_biopsy %}
                  {% set biopsy_date = petition_info.Date_original_biopsy %}
                {% else %}
                  {% set biopsy_date = sample_info.date_original_biopsy %}
                {% endif %}

                <div style="display:inline-block;" id="edit_biopsy_date"> {{ biopsy_date }}</div>  
              </div>

            </div>
          </div>
        </div>
        <div class="col">
          <h5><i class="fas fa-hospital"></i> Centre sanitari</h5>
          <hr style="margin:0px;">
          <div style="margin:0px;">
            <b>Hospital:</b>
            <div style="display:inline-block;" id="edit_hospital">.</div>
          </div>
          <div style="display:inline-block;margin:0px;">
            <b>Sol·licitant:</b> 
            <div style="display:inline-block;" id="edit_physician_name">{{ petition_info.Medical_doctor }}</div>
          </div>

          <div style="display:inline-block;margin:0px;"> 
            <b>Servei: </b>
            <div style="display:inline-block;" id="edit_service"> {{ petition_info.Service }}</div>  
          </div>

        </div>
        <div class="col">
          <h5><i class="fas fa-server"></i> Anàlisi NGS</h5>
          <hr style="margin:0px;">
          <div style="display:inline-block;margin:0px;">
            <div style="display:inline-block;margin:0px;"><b>Data d'anàlisi:</b>  {{ sample_info.analysis_date }}</div>
            <div style="display:inline-block;margin:0px;"><b>Panell:</b>  {{ sample_info.panel }}</div>
          </div>
          <div style="display:inline-block;margin:0px;">
            <div style="display:inline-block;margin:0px;"><b>Pipeline:</b> {{ pipeline_details.pipeline_version }}</div>
          </div>
        </div>
       </div>
      <a class="btn btn-sm btn-secondary" style="float:left;width:80px;padding:0px;color:white;" onclick="updatePatient()"><i class="fas fa-edit"></i>Modifica</a>
    </div>
        
    <div class="card border-1 mt-2">
      <h5 class="card-header">Distribució de variants</h5>
      <div class=" card-body " style="outline-bottom: 1px solid grey;background-color:white;">
      <div class = "row">

        <div class = "col">
          <h6>Freq. canvis</h6>
          <br>
          <div class="chart" id="bar">
          <script>
            var graphs = {{snv_plot | safe}};
            Plotly.plot('bar',graphs,{});
          </script>
          </div>
        </div>
        <div class = "col">
          <h6>VAF</h6>
          <br>
          <div class="chart" id="hist">
          <script>
            var graphs = {{vaf_plot | safe}};
            Plotly.plot('hist',graphs,{});
          </script>
          </div>
        </div>

        <div class = "col">
          <h6>Localització Efecte</h6>
          <br>
          <div class="chart" id="pie">
          <script>
            var graphs = {{pie_plot | safe}};
            Plotly.plot('pie',graphs,{});
          </script>
          </div>
        </div>
      </div>
      </div>
    </div>
    <div class="card border-1 mt-4">
      <div class="card">
        <h5 class="card-header">Perfil de <i> Copy Number</i></h5>
      <div class="card-body " style="outline-bottom: 1px solid grey;background-color:white;">
      <div class="chart" id="scatter">
        <script>
          var graphs = {{cnv_plot | safe}};
          Plotly.plot('scatter',graphs,{});
        </script>
      </div>
      </div>
    </div>
    </div>
    </div>
    <div class="tab-pane fade" id="QC" role="tabpanel" aria-labelledby="QC-tab">
      <div class="card card-body border-0 mt-1" style="outline-bottom: 1px solid grey;background-color:white;">
        <div class="row" style="font-size:16px;">
          <div class="col">
            <h5><b><i class="fas fa-angle-right" style="margin-bottom:15px;"></i> Mètriques Generals</b></h5>

            <table class="table table-hover table-sm ">
              <thead>
                <tr>
                    <th colspan="4"></th>
                    <th colspan="3">Call Rate</th>
                    <th colspan="3">Exons no coberts</th>
                </tr>
                <tr>
                    <th>N Reads (M)</th>
                    <th>Reads mapejats (M)</th>
                    <th>Cobertura mitja</th>
                    <th>Enrichment (%)</th>
                    <th>Duplicats PCR (%)</th>
                    <th>20X</th>
                    <th>30X</th>
                    <th>100X</th>
                    <th>20X</th>
                    <th>30X</th>
                    <th>100X</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding-right:20px;">{{ summary_qc_dict['TOTAL_READS']|float|round/10e5 }} </td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['MAPPED_READS']|float|round/10e5 }} ({{ summary_qc_dict['PCT_MAPPED_READS'] }}%)</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['MEAN_COVERAGE_TARGET'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['ROI_PERCENTAGE'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['PCT_PCR_DUPLICATES'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['CALL_RATE']['20X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['CALL_RATE']['30X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['CALL_RATE']['100X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['LOST_EXONS']['total']['20X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['LOST_EXONS']['total']['30X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['LOST_EXONS']['total']['100X'] }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="row mt-3" style="font-size:16px;">
          <div class="col">
          <h5><b><i class="fas fa-angle-right" style="margin-bottom:15px;"></i> Trimming</b></h5>
          <table class="table table-hover table-sm ">
            <thead>
              <th>Long. Read1 (bp)</th>
              <th>Long. Read2 (bp)</th>
              <th>Reads amb adaptadors</th>
              <th>Bases totals (M)</th>
              <th>Bases trimmed (M)</th>
              <th>q20 Rate</th>
              <th>q30 Rate</th>
            </thead>
            <tbody>
              <tr>
                {% set total_bases_before = fastp_dict['summary']['before_filtering']['total_bases'] %}
                {% set total_bases_after = fastp_dict['summary']['after_filtering']['total_bases'] %}
                {% set bases_trimmed = total_bases_before-total_bases_after %}
                <td style="padding-right:20px;">{{ fastp_dict['summary']['after_filtering']['read1_mean_length'] }} </td>
                <td style="padding-right:20px;">{{ fastp_dict['summary']['after_filtering']['read2_mean_length'] }}</td>
                <td style="padding-right:20px;">{{ fastp_dict['adapter_cutting']['adapter_trimmed_reads'] }}</td>
                <td style="padding-right:20px;">{{ (total_bases_before/10e6)|round(3) }}</td>
                <td style="padding-right:20px;">{{ (bases_trimmed/10e6)|round(3) }}</td>
                <td style="padding-right:20px;">{{ (100*(fastp_dict['summary']['after_filtering']['q20_rate']))|float|round(3) }}</td>
                <td style="padding-right:20px;">{{ (100*(fastp_dict['summary']['after_filtering']['q30_rate']))|float|round(3) }}</td>
              </tr>
            </tbody>
          </table>
          </div>
        </div>
        <hr>

        <div class="row mt-3">
          <h5><b><i class="fas fa-angle-right" style="margin-left:15px;margin-bottom:15px;"></i> Qualitats per posició</b></h5>
        </div>
        <div class="row" style="font-size:16px;">
          <div class="col">
            <h6>Read1</h6>
            <div class="chart" id="scatter2">
              <script>
                  var graphs = {{plot_read1 | safe}};
                  Plotly.plot('scatter2',graphs,{});
              </script>
            </div>
          </div>
          <div class="col">
            <h6>Read2</h6>
            <div class="chart" id="scatter3">
              <script>
                  var graphs = {{plot_read2 | safe}};
                  Plotly.plot('scatter3',graphs,{});
              </script>
            </div>
          </div>
        </div>
        <hr>
        <div class="row mt-3">
          <h5><b><i class="fas fa-angle-right"></i> Adaptadors</b></h5>
        </div>
        <div class="row" style="font-size:16px;">
          <div class="col">
            <div class="chart" id="scatter4">
              <script>
                  var graphs = {{r1_adapters_plot | safe}};
                  Plotly.plot('scatter4',graphs,{});
              </script>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="Lost_Exons" role="tabpanel" aria-labelledby="Lost_Exons-tab">

      <div class="card card-body border-0 mt-1" style="outline-bottom: 1px solid grey;background-color:white;">
        <div class="row" style="font-size:16px;">
          <div class="col">
            <h5><b><i class="fas fa-angle-right" style="margin-bottom:15px;"></i> Exons no coberts</b></h5>
            <div class="table-responsive">
              <table id="lost_exons_table" class="table table-striped table-bordered wrap" style="width:100%;background-color:white;">
                <thead>
                  <th>Coordenades</th>
                  <th>Probe Group</th>
                  <th>Gene</th>
                  <th>Isoforma</th>
                  <th>N Exó/Roi</th>
                  <th>20X</th>
                  <th>30X</th>
                  <th>100X</th>
                </thead>
                <tbody>
                  {% for roi in summary_qc_dict['LOST_EXONS']['exons'] %}
                  {% set roi_dict = summary_qc_dict['LOST_EXONS']['exons'][roi] %}
                  {% if roi_dict['COV_THRESHOLD']['20X']|float == 100 %}
                    {% set cov20_color = 'white' %}
                  {% else %}
                    {% set cov20_color = '#ffb2b2' %}

                  {% endif %}
                  <tr>
                    <td style="padding-right:20px;">{{ roi_dict['CHROMOSOME'] }}:{{ roi_dict['START'] }}-{{ roi_dict['END'] }} </td>
                    <td style="padding-right:20px;">{{ roi_dict['PROBE_GROUP'] }}</td>
                    <td style="padding-right:20px;"><a href="https://www.genecards.org/cgi-bin/carddisp.pl?gene={{roi_dict['GENE_NAME']}} "><i>{{ roi_dict['GENE_NAME'] }}</i></a></td>
                    <td style="padding-right:20px;">{{ roi_dict['ENST_ID'] }}</td>
                    <td style="padding-right:20px;">{{ roi_dict['EXON_NUMBER'] }}</td>
                    <td style="padding-right:20px;background-color:{{cov20_color}}">{{ roi_dict['COV_THRESHOLD']['20X'] }}</td>
                    <td style="padding-right:20px;">{{ roi_dict['COV_THRESHOLD']['30X'] }}</td>
                    <td style="padding-right:20px;">{{ roi_dict['COV_THRESHOLD']['100X'] }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if active == "Therapeutic" %}
    <div class="tab-pane fade pt-2 show active" id="Therapeutic" role="tabpanel" aria-labelledby="Therapeutic-tab">
    {% else %}
    <div class="tab-pane fade pt-2 " id="Therapeutic" role="tabpanel" aria-labelledby="Therapeutic-tab">
    {% endif %}
        <div class="d-flex justify-content-center">
          <div class = "row mt-1">
              {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
              {% for category,message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show ml-3" role="alert">
                <span>{{ message }}</span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
                <br>
              </div>
              {% endfor %}
            {% endif %}
          {% endwith %}
          </div>
        </div>

        <div id="message_div" class="alert alert-success alert-dismissible fade show w-50" role="alert" style="margin:0 auto;display:none;">
            <span id="message_span"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <br>
        </div>

        <div style="margin-top:15px;background-color:#e8f4f8;width:100%;padding:10px;">
          <form id="report_form">
            <div class="row">
              <div class="col-4">
                <input type="hidden" id="run_id" name="run_id" value="{{ sample_info.run_id }}">
                <input type="hidden" id="sample" name="sample" value="{{ sample_info.lab_id }}">
                <input type="hidden" id="sample_id" name="sample_id" value="{{ sample_info.lab_id }}">
                <input type="hidden" id="tumor_origin" name="tumor_origin" value="{{ petition_info.Tumour_origin }}">
                <input style="display:inline;" type="checkbox" id="substitute_report" name="substitute_report">
                <label style="display:inline;" for="substitute_report"> Marcar com a informe de substitució</label>
                <br>
                <input style="display:inline;" type="checkbox" id="lowqual_sample" name="lowqual_sample">
                <label style="display:inline;" for="lowqual_sample"> La mostra no compleix els criteris mínims de qualitat </label>
                <br>
                <input style="display:inline;" type="checkbox" id="no_enac" name="no_enac">
                <label style="display:inline;" for="no_enac"> Procediment no acreditat per ENAC </label>
                <br>
                <button type="submit" id="report_button" class="btn btn-secondary btn-sm mt-2">
                  <i class="fas fa-file-alt" style="color:white;"> </i> Generar informe
                </button>
              </div>
              <div class="col-8">
                <div class="row">
                  <div class="col" id="modificacions_container" style="display: none;">
                    <label for="repeat_notes">Llista de modificacions <small>(En cas de reemissió d'informe)</small>:</label>
                    <textarea class="form-control" id="repeat_notes" name="repeat_notes" rows="2"></textarea>
                  </div>
                  <div class="col">
                    <label for="comments">Altres comentaris de qualitat:</label>
                    <textarea class="form-control" id="comments" name="comments" rows="2"></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-5">
              </div>
              <div class="col-7">

              </div>
            </div>

          </form>
        </div>
        <hr>

        <div class="table-responsive-">
          <table id="therapeutic_table" class="table table-sm table-striped table-bordered dt-responsive wrap" style="width:100%;background-color:white;">
            <div id="delete_multiple_button" style="margin-bottom:15px;display:none;">
              <hr>
              <a type="button" type="submit" id="" class="btn btn-light btn-sm" style="background-color:#FFEBCD;">
                <i class="fas fa-trash"></i> Elimina selecció
              </a>
            </div>
            <thead>
              <tr>
                <th></th>
                <th>Accions</th>
                <th>Gen</th>
                <th>Variant</th>
                <th>Bases de dades</th>
              </tr>
            </thead>
            <tbody>
            {% for var in relevant_variants %}
            <tr>
            <td>
              <input type="checkbox" id="check_var_{{ var.hgvsg }}" name="check_therapeutic_variant"/>
            </td>
            <td>
              <div class="row">
                <div class="col">
                  {% if (var.variant_type == "Amplification" or var.variant_type == "Loss" or var.variant_type == "SV") %}
                  <a class="btn btn-outline-primary btn-sm disabled" href="">
                    <i class="fas fa-plus-circle fa"></i> Info
                  </a>
                  {% else %}
                  <a class="btn btn-outline-primary btn-sm" href="{{ url_for('show_therapeutic_details', run_id=sample_info.run_id, sample=sample_info.lab_id, entry_id=var.id, var_classification=var.classification) }} ">
                    <i class="fas fa-plus-circle fa"></i> Info
                  </a>
                  {% endif %}
                </div>
                <div class="col">
                  <a data-toggle="modal" data-target="#edit_report_{{var.id}}" role="button">
                    <i class="fas fa-edit" style="color:rgb(109, 106, 106)"></i><small></small>
                  </a>
                  <a class="" href="{{ url_for('remove_variant', run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, var_id=var.id, var_classification=var.classification) }}" onclick="return confirm('Segur que vols eliminar aquesta Variant?');" method="POST" enctype="multipart/form-data" id="update_therapeutic_variant"><i class="fas fa-trash" style="color: rgba(209, 20, 20, 0.938)"></i><small></small></a>

                  {% set var_json = var.var_json  %}
                  <a onclick='showIgvVariant({{ var_json }});' role="button">
                    <div>
                      <i class="fas fa-image fa" style="border-radius:3px;margin:0px;padding:2px;color:white;background-color:#0d98ba"></i> <small><b>IGV</b></small>
                    </div>
                  </a>
                </div>
              </div>

              <div class="modal fade bd-example-modal" id="edit_report_{{var.id}}" tabindex="-1" aria-labelledby="modal_edit_report_{{var.id}}" aria-hidden="true">
                <form action="{{ url_for('update_therapeutic_variant', run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, var_id=var.id, var_classification=var.classification) }}" method="POST" enctype="multipart/form-data" id="update_therapeutic_variant">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header" style="background-color:rgb(248, 248, 248);">
                        <h4 class="modal-title" id="modal_new_sample">Edita la variant {{ var.hgvsg }} </h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <div class="row mt-3 mb-3">
                          <div class="col">
                            <h6><b>Mou a:</b></h6>
                            <div class="custom-control custom-radio custom-control-inline">
                              <input type="radio" class="custom-control-input" name="variant_category" value="3" id="rare_variant_rare_{{var.id}}" checked>
                              <label class="custom-control-label" for="rare_variant_rare_{{var.id}}">
                                VUS
                              </label>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-sm">
                            <h6><b>Afegeix a la <i>Blacklist</i></b></h6>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-sm">
                            <div class="custom-control custom-checkbox">
                              {% if var.blacklist == "yes" %}
                              <input type="checkbox" style="background-color:green;" name="blacklist_check" value="blacklist" class="custom-control-input" id="blacklist_check_therapeutic_{{var.id}}" checked>
                              {% else %}
                              <input type="checkbox" style="background-color:green;" name="blacklist_check" value="blacklist" class="custom-control-input" id="blacklist_check_therapeutic_{{var.id}}">
                              {% endif %}
                              <label class="custom-control-label" for="blacklist_check_therapeutic_{{var.id}}">
                            </div>
                          </div>
                        </div>

                        </div>
                        <div class="d-flex justify-content-center align-items-center mt-2">
                          <button class="btn btn-primary mt-2 mb-2" style="width:15%;" type="submit" id="edit_therapeutic">Desa canvis</button>
                        </div>
                      </div>
                  </div>
                </form>
              </div>
            </td>
            <td>
                <div class="row">
                  <div class="col">
                    {% if (var.variant_type == "Amplification" or var.variant_type == "Loss" or var.variant_type == "SV") %}
                     <a><b><i>{{ var.gene }}</i></b></a>
                    {% else %}
                      <a href="https://www.genecards.org/cgi-bin/carddisp.pl?gene={{var.gene}} "><b><i>{{ var.gene }}</i></b></a>
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <i>{{ var.enst_id }}</i>
                  </div>
                </div>
                <br>
                {% if var.exon != '.' %}
                  <b>Exó: </b>{{ var.exon }}
                {% else %}
                  <b>Intró: </b>{{ var.intron }}
                {% endif %}
              </td>
              <td style="min-width:150px;max-width:250px;">
                <div class="row">
                  <div class="col" id="{{ var.id }}" style="display:inline-block;" >
                    <span ><b>{{ var.hgvsp }}</b>
                    {% if var.tier_catsalut == "1" %}
                      <span class="badge badge-pill badge-danger">
                        Tier 1
                        <a onclick="loadTierModal(this);" class="link-light">
                         <i class="fas fa-edit" style="color:white;"></i>
                        </a>
                      </span>
                    {% elif var.tier_catsalut == "2" %}
                      <span class="badge badge-pill badge-success">
                        Tier 2
                        <a onclick="loadTierModal(this);" class="link-light">
                         <i class="fas fa-edit" style="color:white;"></i>
                        </a>
                      </span>
                    {% elif var.tier_catsalut == "3" %}
                      <span class="badge badge-pill badge-info">
                        Tier 3
                        <a onclick="loadTierModal(this);" class="link-light">
                         <i class="fas fa-edit" style="color:white;"></i>
                        </a>
                      </span>
                    {% else %}
                      <span class="badge badge-pill badge-secondary">
                        No tier
                        <a onclick="loadTierModal(this);" class="link-light">
                         <i class="fas fa-edit" style="color:white;"></i>
                        </a>
                      </span>
                    {% endif %}
                    </span>
                  </div>
                  <div class="col">
                      {% if (var.variant_type == "Amplification" or var.variant_type == "Loss") %}
                        <b>CN:</b> {{ var.allele_frequency }}
                      {% else %}
                        {% set read_support = var.read_support|int %}
                        {% set depth = var.depth|int %}
                        <b>VAF (%):</b> {{ 100*(read_support/depth)|float|round(5)}}
                      {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    {{ var.hgvsg }}
                  </div>
                  <div class="col">
                    <b>Read support:</b> {{ var.read_support }}
                  </div>
                 </div>
                <div class="row mb-2">
                  <div class="col">
                    {{ var.hgvsc }}
                  </div>
                  <div class="col">
                    <b>Profunditat: </b>{{ var.depth }}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <b> Tipus: </b> {{ var.variant_type }}
                  </div>
                  <div class="col">
                    <b>Max Pop AF: </b>{{ var.max_pop_af }}
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                      <p class="text-truncate;word-wrap:break-word"><b> Localització/Efecte: </b> {{ var.consequence }}</p>
                  </div>
                  <div class="col">
                    <b>Max AF: </b>{{ var.max_af }} <br>
                    {% set var_db_freq = (100*(var.db_detected_number/var.db_sample_count))|float| round(2) %}
                    <b>Freq. DB: </b>{{ var_db_freq }}% {{ var.db_detected_number }}/{{ var.db_sample_count }}
                  </div>
                </div>

                </div>
                {% if (var.blacklist == "yes") %}
                <div class="row">
                  <div class="col">
                    <span class="badge badge-dark">
                      BLACKLIST
                    </span>
                  </div>
                </div>
                {% else %}
                <div class="row">
                  <div class="col">
                  </div>
                </div>
               {% endif %}
              </td>
              <td style="min-width:150px;max-width:250px;">
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.3" cy="12.3" r="10" stroke="darkorange" stroke-width="0.5" fill="darkorange" />
                      <text x="12.5" y="15" font-size="9" text-anchor="middle" fill="white" font-family="Comic Sans MS, sans-serif">
                        CGI 
                      </text>
                      <title>Cancer Genome Interpreter: Summary / CGI Prediction</title>
                    </svg>
                    {{ var.kb['Oncogenic summary'] }} / {{ var.kb['Oncogenic prediction'] }}
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.3" cy="12.3" r="10" stroke="#a1a1ce" stroke-width="0.5" fill="#a1a1ce" />
                      <text x="12.5" y="15" font-size="9" text-anchor="middle" fill="white" font-family="Comic Sans MS, sans-serif">
                        CV
                      </text>
                      <title>ClinVar: Germline / Somatic</title>
                    </svg>
                    {{ var.kb['ClinVar Germline']}} / {{ var.kb['ClinVar Somatic'] }}
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.5" cy="12.5" r="10" fill="none" stroke="#333c87" stroke-width="1.8" />
                      <circle cx="12.5" cy="12.5" r="6.5" fill="none" stroke="#333c87" stroke-width="1.8" />
                      <circle cx="12.5" cy="12.5" r="2.5" fill="#333c87" stroke="#333c87" stroke-width="1" />
                      <title>OncoKB</title>
                    </svg>                   
                    {{ var.kb['OncoKB'] }}
                    {% endif %}
                  </div>
                 </div>
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.3" cy="12.3" r="10" stroke="#333c87" stroke-width="0.5" fill="#333c87" />
                      <text x="12.5" y="15" font-size="12" text-anchor="middle" fill="white" font-family="Comic Sans MS, sans-serif">
                        F
                      </text>
                      <title>Franklink Germline / Somatic</title>
                    </svg>
                    {{ var.kb['Franklin ACMG'] }} / {{ var.kb['Franklin Oncogenicity'] }}
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.3" cy="12.3" r="10" stroke="orange" stroke-width="0.5" fill="orange" />
                      <text x="12.5" y="15" font-size="7" text-anchor="middle" fill="white" font-family="Comic Sans MS, sans-serif">
                        MTBP
                      </text>
                      <title>Molecular Tumor Board Portal</title>
                    </svg>
                    {{ var.kb['MTBP'] }}
                    {% endif %}
                  </div>
                </div>
                <div class="row">

                </div>
              </td>

            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
    </div>

    <div class="tab-pane fade pt-5" id="Rare" role="tabpanel" aria-labelledby="Rare-tab">

      <table id="rare_table" class="table table-sm table-striped table-bordered dt-responsive nowrap" style="width:100%;background-color:white;">
        <thead>
            <tr>
                <th></th>
                <th>Accions</th>
                <th>Gen</th>
                <th>Variant</th>
                <th>Altres</th>
            </tr>
        </thead>
        <tbody>
        {% for var in rare_variants %}
        <tr>
          <td>
            <div class="row">
              <div class="col">
                <a class="btn btn-outline-primary btn-sm" href="{{ url_for('show_therapeutic_details', sample=sample_info.lab_id, run_id=sample_info.run_id, entry_id=var.id, var_classification=var.classification) }} ">
                  <i class="fas fa-plus-circle fa"></i> Info
                </a>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col">
                <a data-toggle="modal" data-target="#edit_rare_report_{{var.id}}" role="button">
                  <i class="fas fa-edit" style="color:rgb(109, 106, 106)"></i><small></small>
                </a>
              </div>
              <div class="col">
                <a class="" href="{{ url_for('remove_variant', run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, var_id=var.id, var_classification=var.classification) }}" onclick="return confirm('Segur que vols eliminar aquesta variant?');" method="POST" enctype="multipart/form-data" id="update_therapeutic_variant"><i class="fas fa-trash" style="color: rgba(209, 20, 20, 0.938)"></i><small></small></a>
              </div>
              <div class="col">
              </div>
              <div class="col">
              </div>
            </div>
            <!-- <hr> -->
            <div class="row mt">
              <div class="col">
                <a data-toggle="modal" data-target="#show_igv{{var.id}}" role="button">
                  <div >
                    <i class="fas fa-image fa" style="border-radius:3px;margin:0px;padding:2px;color:white;background-color:#0d98ba"></i> <small><b>IGV</b></small>
                  </div>
                </a>
              </div>
            </div>

            <div class="modal fade bd-example-modal-lg" id="edit_rare_report_{{var.id}}" tabindex="-1" aria-labelledby="modal_edit_rare_report_{{var.id}}" aria-hidden="true">
              <form action="{{ url_for('update_therapeutic_variant', run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, var_id=var.id, var_classification=var.classification) }}" method="POST" enctype="multipart/form-data" id="update_therapeutic_variant">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header" style="background-color:rgb(248, 248, 248);">
                      <h4 class="modal-title" id="modal_new_sample">Edita la variant {{ var.hgvsg }} </h4>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <div class="row mt-3 mb-3">
                        <div class="col">
                          <h6><b>Mou a:</b></h6>
                          <div class="custom-control custom-radio custom-control-inline">
                            <input type="radio" class="custom-control-input" name="variant_category" value="2" id="actionable_variant_rare_{{var.id}}">
                            <label class="custom-control-label" for="actionable_variant_rare_{{var.id}}">
                              Variants d'alt impacte
                            </label>
                          </div>
                          <!-- <div class="custom-control custom-radio custom-control-inline">
                            <input type="radio" class="custom-control-input" name="variant_category" value="3" id="rare_variant_rare_{{var.id}}" checked>
                            <label class="custom-control-label" for="rare_variant_rare_{{var.id}}">
                              VUS
                            </label>
                          </div> -->
                        </div>
                      </div>
                      <hr>

                      <div class="row">
                        <div class="col-sm">
                          <h6><b>Blacklist:</b></h6>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-sm">
                          <div class="custom-control custom-checkbox">
                            {% if var.blacklist == "yes" %}
                            <input type="checkbox" style="background-color:green;" name="blacklist_check" value="blacklist" class="custom-control-input" id="bioinfo_check_rare_{{var.id}}" checked>
                            {% else %}
                            <input type="checkbox" style="background-color:green;" name="blacklist_check" value="blacklist" class="custom-control-input" id="bioinfo_check_rare_{{var.id}}">
                            {% endif %}
                            <label class="custom-control-label" for="bioinfo_check_rare_{{var.id}}">
                          </div>
                        </div>
                      </div>
                      </div>
                      <div class="d-flex justify-content-center align-items-center mt-2">
                        <button class="btn btn-primary mt-2 mb-2" style="width:15%;" type="submit" id="edit_therapeutic">Desa canvis</button>
                      </div>
                    </div>
                </div>
              </form>
            </div>
          </td>
        <td>
            <div class="row">
              <div class="col">
                 <a href="https://www.genecards.org/cgi-bin/carddisp.pl?gene={{var.gene}} "><b><i>{{ var.gene }}</i></b></a>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <i>{{ var.enst_id }}</i>
              </div>
            </div>
            <br>
            {% if var.exon != '.' %}
              <b>Exó: </b>{{ var.exon }}
            {% else %}
              <b>Intró: </b>{{ var.intron }}
            {% endif %}
          </td>
          <td>
            <div class="row">
              <div class="col">
                <b>{{ var.hgvsp }}</b>
              </div>
            </div>
            <div class="row">
              <div class="col">
                {{ var.hgvsg }}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col">
                {{ var.hgvsc }}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b> Tipus: </b> {{ var.variant_type }}
              </div>
            </div>
            <b> Localització/Efecte: <br></b> {{ var.consequence }}
            {% if (var.blacklist == "yes") %}
            <span class="badge badge-dark">
              BLACKLIST
            </span>
            {% endif %}
          </td>
          <td>
            <div class="row">
              <div class="col">

                {% set read_support = var.read_support|float %}
                {% set depth = var.depth|float %}



                <b>VAF (%):</b> {{ 100*(read_support/depth)|float|round(4)}}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b>Read support:</b> {{ var.read_support }}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b>Profunditat: </b>{{ var.depth }}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b>Max Pop AF: </b>{{ var.max_pop_af }}
              </div>
              <div class="col">
                <b>Max AF: </b>{{ var.max_af }}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b>Freq. DB: </b>{{ var.db_detected_number }} / {{ var.db_sample_count }}  {{ var.db_detected_freq |float | round(3) }}
              </div>
            </div>
          </td>
          <!-- <td>{{ var.therapies }}</td> -->
          <td>{{ var.tumor_type }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="tab-pane fade pt-5" id="CNA" role="tabpanel" aria-labelledby="CNA-tab">
      <table id="cnas_table" class="table table-sm table-striped table-bordered dt-responsive nowrap" style="width:100%;background-color:white;">
        <thead>
            <tr>
                <th>Chr</th>
                <th>Pos</th>
                <th>Alt</th>
                <th>Gens</th>
                <th>Tipus</th>
                <th>Ratio (log2)</th>
                <th>N Còpies</th>
                <th>N Rois</th>
            </tr>
        </thead>
        <tbody>
        {% for var in all_cnas %}
        <tr>
          <td>
            <div class="row">
              <div class="col">
                {{ var.chromosome }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.start }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.end }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.genes }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.svtype }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.ratio }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.cn }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.qual }}
              </div>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="tab-pane fade pt-5" id="Fusions" role="tabpanel" aria-labelledby="Fusion-tab">
      <table id="fusions_table" class="table table-sm table-striped table-bordered dt-responsive nowrap" style="width:100%;background-color:white;">
        <thead>
            <tr>
              <th>Chr</th>
              <th>Pos</th>
              <th>Alt</th>
              <th>Qual</th>
              <th>SV</th>
              <th>PR</th>
              <th>SR</th>
              <th>Prof.</th>
              <th>VAF</th>
              <th>Partners</th>
              <th>Flanking genes</th>
            </tr>
        </thead>
        <tbody>
        {% for var in all_fusions %}
        <tr>
          <td>
            <div class="row">
              <div class="col">
                {{ var.chromosome }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.start }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.end }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.qual }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.svtype }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.read_pairs }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.split_reads }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.depth }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.vaf | float | round(2) }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.fusion_partners }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.flanking_genes  }}
              </div>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

</div>

{% block script %}
<script>


  document.getElementById('substitute_report').addEventListener('change', function() {
    var modificacionsContainer = document.getElementById('modificacions_container');
    if (this.checked) {
      modificacionsContainer.style.display = 'block';
    } else {
      modificacionsContainer.style.display = 'none';
    }
  });

  function updatePatient() {   
    edit_lab_id = document.getElementById("edit_lab_id").innerText;
    edit_modulab_id = document.getElementById("edit_modulab_id").innerText;
    edit_ext2_id = document.getElementById("edit_ext2_id").innerText;
    edit_ext3_id = document.getElementById("edit_ext3_id").innerText;

    edit_sample_type = document.getElementById("edit_sample_type").innerText;
    edit_recieved_date = document.getElementById("edit_recieved_date").innerText;
    edit_tumoral_pct = document.getElementById("edit_tumoral_pct").innerText;
    edit_hospital = document.getElementById("edit_hospital").innerText;
    edit_physician = document.getElementById("edit_physician_name").innerText;
    edit_biopsy_date = document.getElementById("edit_biopsy_date").innerText;
    edit_tumor_origin = document.getElementById("edit_tumor_origin").innerText;
    edit_age = document.getElementById("edit_age").innerText;
    edit_sex = document.getElementById("edit_sex").innerText;
    edit_sample_block = document.getElementById("edit_sample_block").innerText;
    edit_service = document.getElementById("edit_service").innerText;

    myarr = edit_biopsy_date.split("/");
    if (myarr.length == 3) {
      biopsy_date = myarr[2]+"-"+myarr[1]+"-"+myarr[0];
    }
    else {
      biopsy_date = edit_biopsy_date
    }


    myarr = edit_recieved_date.split("/");

    if (myarr.length == 3) {
      recieved_date = myarr[2]+"-"+myarr[1]+"-"+myarr[0];
    }
    else {
      recieved_date = edit_recieved_date
    }


    document.getElementById("modal_edit_lab_id").value = edit_lab_id;
    document.getElementById("modal_edit_modulab_id").value = edit_modulab_id;
    document.getElementById("modal_edit_ext2_id").value = edit_ext2_id;
    document.getElementById("modal_edit_ext3_id").value = edit_ext3_id;
    document.getElementById("modal_edit_sample_type").value = edit_sample_type;
    document.getElementById("modal_edit_hospital").value = edit_hospital;
    document.getElementById("modal_edit_physician_name").value = edit_physician;
    document.getElementById("modal_edit_biopsy_date").value = biopsy_date;
    document.getElementById("modal_edit_recieved_date").value = recieved_date;
    document.getElementById("modal_edit_tumor_origin").value = edit_tumor_origin;
    document.getElementById("modal_edit_age").value = edit_age;
    document.getElementById("modal_edit_sex").value = edit_sex;

    document.getElementById("modal_edit_sample_block").value = edit_sample_block;
    document.getElementById("modal_edit_service").value = edit_service;


    if (edit_tumoral_pct != ".") {
      edit_tumoral_pct = edit_tumoral_pct.replace("%", "");
      document.getElementById("modal_edit_tumoral_pct").value = edit_tumoral_pct;
    }
    $('#edit_sample').modal('show');
  }


  button_tier_modal = document.getElementById("change_sample_info_button");
  button_tier_modal.addEventListener("click", updatePatient2);

  function updatePatient2() {
    lab_id = document.getElementById("modal_edit_lab_id").value;
    modulab_id = document.getElementById("modal_edit_modulab_id").value;
    // ap_id = document.getElementById("modal_edit_ext1_id").value;
    hc_id = document.getElementById("modal_edit_ext2_id").value;
    cip_id = document.getElementById("modal_edit_ext3_id").value;
    sample_type = document.getElementById("modal_edit_sample_type").value;
    hospital = document.getElementById("modal_edit_hospital").value;
    tumor_pct =  document.getElementById("modal_edit_tumoral_pct").value;
    physician_name = document.getElementById("modal_edit_physician_name").value;
    tumor_origin = document.getElementById("modal_edit_tumor_origin").value;

    recieved_date = document.getElementById("modal_edit_recieved_date").value;
    biopsy_date = document.getElementById("modal_edit_biopsy_date").value;

    if (biopsy_date) {
      let tmp = biopsy_date.split("-");
      biopsy_date = tmp[2] + "/" + tmp[1] + "/" +tmp[0];
    }

    sex = document.getElementById("modal_edit_sex").value; 
    age = document.getElementById("modal_edit_age").value; 

    sample_block = document.getElementById("modal_edit_sample_block").value;
    service = document.getElementById("modal_edit_service").value;

    old_lab_id = document.getElementById("edit_lab_id").innerText;
    old_ext1_id = document.getElementById("edit_lab_id").innerText;
    run_id = document.getElementById("run_id_tag").innerText;

    let data_json = {
      run_id: run_id,
      old_lab_id: old_lab_id,
      old_ext1_id: old_ext1_id,
      lab_id: lab_id,
      modulab_id: modulab_id,
      ext1_id: lab_id,
      ext2_id: hc_id,
      ext3_id: cip_id,
      sample_type: sample_type,
      hospital: hospital,
      tumor_pct: tumor_pct,
      physician_name: physician_name,
      recieved_date: recieved_date,
      biopsy_date: biopsy_date,
      tumor_origin: tumor_origin,
      sex: sex,
      age: age,
      sample_block: sample_block,
      service: service

    }

    fetch('/update_patient_info', {
      method: "POST",
      headers: {
        'Content-Type': 'application/json'
      },
      body:JSON.stringify(data_json)
    })
    .then((response) => response.json())
    .then((data) => {
      document.getElementById("message_div").style.display = "block";
      document.getElementById("message_span").innerHTML = data["info"];
      console.log(data["info"]);
      $('#edit_sample').modal('hide');
    }).then(() => {
      window.location.reload();
    });


  }


  function loadTierModal(event) {

    tier = event.parentElement.innerText;
    var_id = event.parentElement.parentElement.parentElement.id;
    tier_modal = document.getElementById("tier_modal");
    modal_var_id = document.getElementById("modal_var_id").innerText = var_id;
    document.getElementById("tier_1").checked = false;
    document.getElementById("tier_2").checked = false;
    document.getElementById("tier_3").checked = false;
    document.getElementById("no_tier").checked = false;

    if (tier.includes("1")) {
       document.getElementById("tier_1").checked = true;
    }
    if (tier.includes("2")) {
      document.getElementById("tier_2").checked = true;
    }
    if (tier.includes("3")) {
      document.getElementById("tier_3").checked = true;
    }
    if (tier.includes("3")) {
      document.getElementById("tier_3").checked = true;
    }
    if (tier.includes("No")) {
      document.getElementById("no_tier").checked = true;
    }
    $('#tier_modal').modal('show');
    console.log(tier);
  }

  button_tier_modal = document.getElementById("change_tier_button");
  button_tier_modal.addEventListener("click", modifyTierModal);
  function modifyTierModal() {
    let tier = document.querySelector('input[name="change_tier[]"]:checked').value;
    let modal_var_id = document.getElementById("modal_var_id").innerText;
    let body_data = {
      "tier": tier,
      "var_id": modal_var_id
    }

    fetch('/modify_tier', {
      method: "POST",
      headers: {
        'Content-Type': 'application/json'
      },
      body:JSON.stringify(body_data)
    })
    .then((response) => response.json())
    .then((data) => {
      document.getElementById("message_div").style.display = "block";
      document.getElementById("message_span").innerHTML = data["info"];
      console.log(data["info"]);
      $('#tier_modal').modal('hide');
    }).then(() => {
            window.location.reload();
        });
  }


  function showIgvVariant(locus) {
    var start = parseInt(locus['POS']) +2;
    var coordinates = locus['CHROM'] + ':' + start.toString();
    console.log(coordinates);

    var igvDiv = document.getElementById('igvDiv');
    igvDiv.innerHTML = "";
    igv.removeAllBrowsers();

    $('#show_igv').modal('show');

    igvDiv.innerHTML = `<div id="igv_lodader"><span  class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Carregant IGV...</div>`;
    var options =
      {
          locus: coordinates,
          genome: "hg19",
          showCenterGuide: true,
          tracks:[
            {
              type:'alignment',
              format: 'bam',
              url : "{{ url_for('download_sample_bam', run_id=sample_info.run_id, sample=sample_info.lab_id) }}" ,
              indexURL: "{{ url_for('download_sample_bai', run_id=sample_info.run_id, sample=sample_info.lab_id) }}"
            }
          ]
      };
      setTimeout(function(){
        igv.createBrowser(igvDiv, options)
            .then(function (browser) {
                document.getElementById('igv_lodader').remove();
                igv.browser = browser;
                console.log("Created IGV browser");
            });
    }, 3000);

  }


  var report_form = document.forms.namedItem("report_form");
  report_form.addEventListener('submit', generateReport, false);

  function generateReport(event) {
     report_button = document.getElementById('report_button');
     report_button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generant informe...`;

     let formData = new FormData(document.forms.namedItem("report_form"));

     ms = document.getElementById("message_span");
     if (ms) {
       ms.innerHTML = "";
     }

     var request = new XMLHttpRequest();
     request.open("POST", "/create_somatic_report", true);
     request.onload = function(oEvent) {
       if (request.status == 200) {
         var response_json = JSON.parse(request.responseText);
         var display_message = response_json.message_text;
         report_button.innerHTML = `<i class="fas fa-file-alt" style="color:white;"> </i> Generar informe`;

         document.getElementById("message_div").style.display = "block";
         document.getElementById("message_span").innerHTML = "Nou informe generat correctament!";

       }
       else {
         console.log("error")
       }
     };
     request.send(formData);
     event.preventDefault();
   }

  function selectAllVariants() {

     var check_all_therapeutic = $('#check_all_therapeutic').prop('checked');
     if (check_all_therapeutic == true) {
       $('input[name="check_therapeutic_variant"]').each(function() {
     			this.checked = true;
     		});
        $('#delete_multiple_button').show();
     }
     else {
       $('input[name="check_therapeutic_variant"]').each(function() {
     			this.checked = false;
     		});
       $('#delete_multiple_button').hide();
     }
   }

 </script>
{% endblock %}

{% endblock body %}
