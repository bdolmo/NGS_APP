{% extends "base.html" %}

{% block body %}


<!-- The Modal -->
<!-- Button to Open the Modal -->


<!-- The Modal -->
<div class="modal fade" id="addVariantModal" tabindex="-1" aria-labelledby="addVariantModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="addVariantModalLabel">Afegeix una nova variant</h5>

              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          <div class="modal-body">
              <form id="addVariantForm">
                  <div class="row mb-3">
                      <div class="col">
                          <label for="gene" class="form-label">Gen <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" id="gene" name="gene" required>
                          <small><p>En el cas de fusions es recomana afegir el partner <i>(e.g. EML4::ALK)</i></p></small>

                      </div>
                      <div class="col">
                          <label for="enst_id" class="form-label">Isoforma</label>
                          <input type="text" class="form-control" id="new_enst_id" name="new_enst_id">
                      </div>
                  </div>
                  <div class="row mb-3">
                      <div class="col">
                          <label for="hgvsg" class="form-label">HGVSg</label>
                          <input type="text" class="form-control" id="hgvsg" name="hgvsg">
                      </div>

                  </div>
                  <div class="row mb-3">
                    <div class="col">
                        <label for="hgvsc" class="form-label">HGVSc</label>
                        <input type="text" class="form-control" id="hgvsc" name="hgvsc" >
                    </div>
                      <div class="col">
                          <label for="hgvsp" class="form-label">HGVSp</label>
                          <input type="text" class="form-control" id="hgvsp" name="hgvsp">
                      </div>
                  </div>
                  <div class="row mb-3">
                      <div class="col">
                          <label for="variant_type" class="form-label">Tipus de variant<label>

                          <select class="form-control" id="variant_type" name="variant_type" required>
                            <option value="">Seleccioneu...</option>
                            <option value="SNV">SNV</option>
                            <option value="Indel">Indel</option>
                            <option value="SV">SV</option>
                            <option value="CNA">CNA</option>
                        </select>


                      </div>
                      <div class="col">
                          <label for="exon" class="form-label">Exó</label>
                          <input type="text" class="form-control" id="exon" name="exon">
                      </div>
                  </div>
                  <div class="row mb-3">
                      <div class="col">
                          <label for="intron" class="form-label">Intró </label>
                          <input type="text" class="form-control" id="intron" name="intron" >
                      </div>
                      <div class="col">
                        <label for="read_support" class="form-label">Read Support <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="read_support" name="read_support" required>
                    </div>
                  </div>
                  <div class="row mb-3">
                      <div class="col">
                          <label for="allele_frequency" class="form-label">Freq. al·lèlica (0 - 1)</label>
                          <input type="number" class="form-control" id="allele_frequency" name="allele_frequency" step="0.01" readonly>
                      </div>
                      <div class="col">
                        <label for="depth" class="form-label">Profunditat <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="depth" name="depth" required>
                    </div>


                  </div>
                  <div class="row mb-3">
                      <div class="col">
                          <label for="tier_catsalut" class="form-label">Tier Catsalut</label>
                          <select class="form-control" id="tier_catsalut" name="tier_catsalut" required>
                              <option value="1">1</option>
                              <option value="2">2</option>
                              <option value="3">3</option>
                              <option value="4">4</option>
                          </select>
                      </div>
                  </div>
                  <button type="submit" class="btn btn-primary">Accepta</button>
              </form>
          </div>
      </div>
  </div>
</div>

<div id="edit_sample" class="modal fade">
  <!-- <form action="" method="POST" enctype="multipart/form-data" id="update_petition"> -->
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color:rgb(248, 248, 248);">
          <h4 class="modal-title" id="edit_petition_name">Dades demogràfiques</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row mt-3">
            <div class="col-sm">
              <h6><b>Lab ID</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_lab_id" value="" type="text" name="modal_edit_lab_id" class="form-control" placeholder="">
              </div>
            </div>

            <div class="col-sm">
              <h6><b>Nº Petició</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_modulab_id" value="" type="text" name="modal_edit_modulab_id" class="form-control" placeholder="">
              </div>
            </div>

            <div class="col-sm">
              <h6><b>HC</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_ext2_id" value="" type="text" name="modal_edit_ext2_id" class="form-control" placeholder="">
              </div>
            </div>
            <div class="col-sm">
              <h6><b>CIP</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_ext3_id" value="" type="text" name="modal_edit_ext3_id" class="form-control" placeholder="">
              </div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-sm">
              <h6><b>Edat</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_age" value="" type="text" name="modal_edit_age" class="form-control" placeholder="">
              </div>
            </div>
            <div class="col-sm">
              <h6><b>Sexe</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_sex" value="" type="text" name="modal_edit_sex" class="form-control" placeholder="">
              </div>
            </div>
            <div class="col-sm ">
              <h6><b>Metge sol·licitant</b></h6>
              <input id="modal_edit_physician_name" type="text" name="modal_edit_physician_name" class="form-control" >
            </div>
            <div class="col-sm ">
              <h6><b>Hospital</b></h6>
              <input id="modal_edit_hospital" type="text" name="modal_edit_hospital" class="form-control" >
            </div>

          </div>

          <div class="row mt-3">
            <div class="col-3">
              <h6><b>Origen tumoral</b></h6>
              <input id="modal_edit_tumor_origin" type="text" name="modal_edit_tumor_origin" class="form-control" >
            </div>
            <div class="col-3 ">
              <h6><b>Bloc AP</b></h6>
              <input id="modal_edit_sample_block" type="text" name="modal_edit_sample_block" class="form-control" >
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-sm">
              <h6><b>Tipus de mostra</b></h6>
              <div class="input-group mb-3">
                <input id="modal_edit_sample_type" value="" type="text" name="modal_edit_sample_type" class="form-control" placeholder="">
              </div>
            </div>
            <div class="col-sm ">
              <h6><b>%Tumoral</b></h6>
              <select class="custom-select" name="modal_edit_tumoral_pct" id="modal_edit_tumoral_pct">
                {% for n in range(0, 100, 5) %}
                <option value="{{n}}">{{n}}</option>
                {% endfor %}
              </select>
            </div>


            <div class="col-sm ">
              <h6><b>Servei sol·licitant</b></h6>
              <input id="modal_edit_service" type="text" name="modal_edit_service" class="form-control" >
            </div>

          </div>

          <div class="row mt-3">
            <div class="col-sm">
              <h6><b>Data biòpsia original</b> <small>(MM/DD/YYYY)</small></h6>
              <div class="form-group">
                <div id="datepicker" data-provide="datepicker">
                  <input class="form-control" name="Date" type="date" value="" id="modal_edit_biopsy_date">
                  <div class="input-group-addon">
                      <span class="glyphicon glyphicon-th"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm">
              <h6><b>Data de rebuda</b> <small>(MM/DD/YYYY)</small></h6>
              <div class="form-group">
                <div id="datepicker" data-provide="datepicker">
                  <input class="form-control" name="Date" type="date" value="" id="modal_edit_recieved_date">
                  <div class="input-group-addon">
                      <span class="glyphicon glyphicon-th"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-center align-items-center mt-1 mb-2">
          <button class="btn btn-primary mt-2 mb-2" style="width:15%;" type="submit" id="change_sample_info_button">Desa</button>
        </div>
      </div>
    </div>
  <!-- </form> -->
</div>

<div class="modal fade bd-example-modal-xl" id="show_igv" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color:rgb(248, 248, 248);">
        <h4 class="modal-title" id=""><b>IGV</b> </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="margin:0 auto;width:100%;height:100%">
          <div id='igvDiv' style="width:100%;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="tier_modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header" style="background-color:rgb(248, 248, 248);">
        <h4 class="modal-title" id="tier_title">Modifica la Tier </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="">
        <div id='tierDiv' style="width:100%;">
          <input type="radio" id="tier_1" name="change_tier[]" value="1">
          <label for="tier_1">Tier 1</label><br>
          <input type="radio" id="tier_2" name="change_tier[]" value="2">
          <label for="tier_2">Tier 2</label><br>
          <input type="radio" id="tier_3" name="change_tier[]" value="3">
          <label for="tier_3">Tier 3</label><br>
          <input type="radio" id="no_tier" name="change_tier[]" value="4">
          <label for="no_tier">No tier</label><br>
          <p id="modal_var_id" style="display:none;"></p>
        </div>
        <hr>
        <button id="change_tier_button" style="margin:0px auto;" class="btn btn-primary btn-sm">Accepta</button>
      </div>
    </div>
  </div>
</div>

<div id="main_flex" class="d-flex" >

<!-- Sidebar -->
<div class="bg-light border-right vh-100" id="sidebar-wrapper"style="position:fixed;width:15%;">
  <div class="list-group list-group-flush">
    <div href="#" class="list-group-item list-group-item-action" style="background-color:#d9f7f7;">
      
      <div style="font-size:24px;"><img class="card-img rounded-circle" style="width:32px;height:32px;font-size:28px;" src="{{ session['avatar'] }}">
    {{ session["username"] }} <i style="color:green;font-size:14px" class="fas fa-circle"></i><span style="font-size:13px;"> Online</span></div>
    
    <!-- <p style="font-size:13px;"><b>Últim accés:</b>  </p> -->
   </div>
    <div href="#" class="list-group-item list-group-item-action bg-light">
      <div class="row">
        <div class="col">
          <i class="fas fa-external-link-alt"> </i><b> Últims 5 runs</b>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <ul>
          {% for job in All_jobs %}
            <li> <a style="word-wrap:break-word;color:{{colour}};" href="{{ url_for('show_run_details', run_id=job.Job_id) }}"><b>{{ job.Job_id }}</b></a></li>
          {% endfor %}
         </ul>
        </div>
     </div>
    </div>

    <div href="#" class="list-group-item list-group-item-action bg-light">
      <div class="row">
        <div class="col">
          <i class="fas fa-list"> </i> <b>Últimes 10 accions</b>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <ul>
          {% for change in All_changes_dict %}
            {% if All_changes_dict[change]['action_data']['action_json']['origin_action'] == "Create report" %}
              {% set colour = "" %}
            {% endif %}
            {% if All_changes_dict[change]['action_data']['action_json']['origin_action'] == "delete" %}
              {% set colour = "red" %}
            {% endif %}

            {% if 'redo' in All_changes_dict[change]['action_data']['action_json'] %}
              {% if All_changes_dict[change]['action_data']['action_json']['redo'] == True %}

              <li>
                <a style="word-wrap:break-word;colour:{{colour}};">{{ All_changes_dict[change]['action_name'] }}
                  <a style="word-wrap:break-word;color:{{colour}};" href="{{ url_for('redo_action', action_id=change, run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, active="General")}}" role="button">
                    <span class="badge badge-secondary"><i class="fas fa-redo"></i></span>
                  </a>
                </a>
              </li>
              {% else %}
              <li>
                <a style="word-wrap:break-word;color:{{colour}};">{{ All_changes_dict[change]['action_name'] }}
                 <a href="{{ url_for('redo_action', action_id=change, run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, active="General")}}" role="button"></a>
               </a>
              </li>
              {% endif %}
            {% else %}
              <li>
                <a style="word-wrap:break-word;">{{ All_changes_dict[change]['action_name'] }}
                  <a href="{{ url_for('redo_action', action_id=change, run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, active="General")}}" role="button">
                    <span class="badge badge-secondary"><i class="fas fa-redo"></i></span>
                  </a>
                </a>
              </li>
            {% endif %}
          {% endfor %}
         </ul>
        </div>
     </div>
    </div>
  </div>
</div>

<div class="container-fluid rounded" style="margin-right:90px;background-color:white; width:80%">

  <nav aria-label="breadcrumb ">
    <ol class="breadcrumb mt-3 p-1">
      <li class="breadcrumb-item"><a href="{{ url_for('status') }}">Resultats</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('show_run_details', run_id=sample_info.run_id) }}" id="run_id_tag">{{ sample_info.run_id }}</a></li>
      <li class="breadcrumb-item active" aria-current="page"><h5 id="lab_id_tag">{{ sample_info.lab_id }}</h5></li>
    </ol>
  </nav>

  <ul class="nav nav-tabs">
    <li class="nav-item">
      {% if active == "General" %}
        <a class="nav-link active" id="General-tab" data-toggle="tab" href="#General">General</a>
      {% else %}
        <a class="nav-link" id="General-tab" data-toggle="tab" href="#General">General</a>
      {% endif %}
    </li>
    <li class="nav-item">
      <a class="nav-link" id="QC-tab" data-toggle="tab" href="#QC">QC</a>
    </li>

    <li class="nav-item">
      <a class="nav-link" id="Lost_Exons-tab" data-toggle="tab" href="#Lost_Exons">Exons no coberts</a>
    </li>

    <li class="nav-item">
      {% if active == "Therapeutic" %}
        <a class="nav-link active" id="Therapeutic-tab" data-toggle="tab" href="#Therapeutic" >Variants d'alt impacte</a>
      {% else %}
        <a class="nav-link" id="Therapeutic-tab" data-toggle="tab" href="#Therapeutic">Variants d'alt impacte</a>
      {% endif %}
    </li>

    <li class="nav-item">
      {% if active == "Rare" %}
        <a class="nav-link active" id="Rare-tab" data-toggle="tab" href="#Rare">Variants VUS</a>
      {% else %}
        <a class="nav-link" id="Rare-tab" data-toggle="tab" href="#Rare">Variants VUS</a>
      {% endif %}
    </li>
    <li class="nav-item">
      <a class="nav-link" id="CNA-tab" data-toggle="tab" href="#CNA">CNA</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="Fusion-tab" data-toggle="tab" href="#Fusions">Fusions</a>
    </li>
  </ul>

  <div class="tab-content">
    {% if active == "General" %}
    <div class="tab-pane fade show active" id="General" role="tabpanel" aria-labelledby="General-tab">
    {% else %}
    <div class="tab-pane fade" id="General" role="tabpanel" aria-labelledby="General-tab">
    {% endif %}
    <div class="card card-body border-0 " style="padding:4px;background-color:white;">

      <div class="row" style="font-size:16px;">
        <div class="col-4">
          <h5><i class="fas fa-id-card"></i> Pacient</h5>      
          <a class="btn btn-sm btn-secondary" style="float:left;width:80px;padding:0px;color:white;" onclick="updatePatient()"><i class="fas fa-edit"></i>Modifica</a>

          <hr style="margin:0px;">
          <div class="row">
            <div class="col">

              <div style="margin:0px;">
                <b style="display:inline-block;">Petició: </b>
                <div style="display:inline-block;margin:0px;" id="edit_modulab_id"> {{ sample_info.modulab_id }}</div>
              </div>

              <div style="margin:0px;">
                <b style="display:inline-block;">Lab ID: </b>
                <div style="display:inline-block;" id="edit_lab_id">{{ sample_info.lab_id }}</div>
              </div>

              <div style="display:inline-block;margin:0px;">
                <b style="display:inline-block;">Edat: </b>
                <div style="display:inline-block;" id="edit_age">{{ sample_info.Age|int }} </div>
              </div>

            </div>
            <div class="col">
              <div style="margin:0px;">
                <b style="display:inline-block;">CIP: </b>
                <div style="display:inline-block;margin:0px;" id="edit_ext3_id"> {{ sample_info.ext3_id }}</div>
              </div>
              <div style="margin:0px;">
                <b style="display:inline-block;">Núm. HC: </b>
                <div style="display:inline-block;margin:0px;" id="edit_ext2_id"> {{ sample_info.ext2_id }}</div>
              </div>
              <div style="display:inline-block;margin:0px;">
                <b style="display:inline-block;">Sexe: </b>
                <div style="display:inline-block;" id="edit_sex">{{ sample_info.Sex }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-4">
          <h5><i class="fas fa-vials"></i> Mostra</h5>
          <hr style="margin:0px;">


          <p style="display:none;" id="sample_num_id"> {{sample_info.id}}</p>

          <div class="row">
            <div class="col">
              <div style="display:inline-block;margin:0px;">
                <b>Tipus de mostra: </b>
                <div style="display:inline-block;" id="edit_sample_type">bloc de parafina</div>
              </div>
              <div style="margin:0px;">
                <b>Data de rebuda: </b>

                {% set petition_date = "." %}
                {% if petition_info.Petition_date %}
                  {% set petition_date = petition_info.Petition_date %}
                {% else %}
                  {% set petition_date = sample_info.petition_date %}
                {% endif %}

                <div style="display:inline-block;" id="edit_recieved_date"> {{ petition_date }}</div>
              </div>
              <div style="display:inline-block;margin:0px;"> 
                <b>Bloc AP: </b>

                  {% set sample_block = "." %}
                  {% if petition_info.Sample_block %}
                    {% set sample_block = petition_info.Sample_block %}
                  {% else %}
                    {% set sample_block = sample_info.sample_block %}
                  {% endif %}

                <div style="display:inline-block;" id="edit_sample_block"> {{ sample_block }}</div>  
              </div>

            </div>
            <div class="col">
              <div style="display:inline-block;margin:0px;"> 
                <b>Origen tumoral: </b>

                {% set tumour_origin = "." %}
                {% if petition_info.Tumour_origin %}
                  {% set tumour_origin = petition_info.Tumour_origin %}
                {% else %}
                  {% set tumour_origin = sample_info.tumor_origin %}
                {% endif %}

                <div style="display:inline-block;" id="edit_tumor_origin"> {{ tumour_origin }}</div>  
              </div>
              <div style="display:inline-block;margin:0px;"> 
                <b>Puresa tumoral: </b>

                {% set tumour_purity = "." %}
                {% if petition_info.Tumour_pct %}
                  {% set tumour_purity = petition_info.Tumour_pct %}
                {% else %}
                  {% set tumour_purity = sample_info.tumour_purity %}
                {% endif %}

                <div style="display:inline-block;" id="edit_tumoral_pct"> {{ tumour_purity}}%</div>  
              </div>
              <div style="display:inline-block;margin:0px;"> 
                <b>Data biòpsia: </b>

                {% set biopsy_date = "." %}
                {% if petition_info.Date_original_biopsy %}
                  {% set biopsy_date = petition_info.Date_original_biopsy %}
                {% else %}
                  {% set biopsy_date = sample_info.date_original_biopsy %}
                {% endif %}

                <div style="display:inline-block;" id="edit_biopsy_date"> {{ biopsy_date }}</div>  
              </div>

            </div>
          </div>
        </div>
        <div class="col">
          <h5><i class="fas fa-hospital"></i> Centre sanitari</h5>
          <hr style="margin:0px;">
          <div style="margin:0px;">
            <b>Hospital:</b>
            <div style="display:inline-block;" id="edit_hospital">.</div>
          </div>
          <div style="display:inline-block;margin:0px;">
            <b>Sol·licitant:</b> 
            <div style="display:inline-block;" id="edit_physician_name">{{ petition_info.Medical_doctor }}</div>
          </div>

          <div style="display:inline-block;margin:0px;"> 
            <b>Servei: </b>
            <div style="display:inline-block;" id="edit_service"> {{ petition_info.Service }}</div>  
          </div>

        </div>
        <div class="col">
          <h5><i class="fas fa-server"></i> Anàlisi NGS</h5>
          <hr style="margin:0px;">
          <div style="display:inline-block;margin:0px;">
            <div style="display:inline-block;margin:0px;"><b>Data d'anàlisi:</b>  {{ sample_info.analysis_date }}</div>
            <div style="display:inline-block;margin:0px;"><b>Panell:</b>  {{ sample_info.panel }}</div>
          </div>
          <div style="display:inline-block;margin:0px;">
            <div style="display:inline-block;margin:0px;"><b>Pipeline:</b> {{ pipeline_details.pipeline_version }}</div>
          </div>
        </div>
       </div>
    </div>
        
    <div class="card border-1 ">
      <h6 class="card-header" style="padding:4px;">Distribució de variants</h6>
      <div class=" card-body " style="outline-bottom: 1px solid grey;background-color:white;">
      <div class = "row">

        <div class = "col">
          <h6>Freq. canvis</h6>
          <div class="chart" id="bar">
          <script>
            var graphs = {{snv_plot | safe}};
            // Plotly.plot('bar',graphs,{});
          </script>
          </div>
        </div>
        <div class = "col">
          <h6>VAF</h6>
          <div class="chart" id="hist">
          <script>
            var graphs = {{vaf_plot | safe}};
            // Plotly.plot('hist',graphs,{});
          </script>
          </div>
        </div>

        <div class = "col">
          <h6>Localització Efecte</h6>
          <div class="chart" id="pie">
          <script>
            var graphs = {{pie_plot | safe}};
            // Plotly.plot('pie',graphs,{});
          </script>
          </div>
        </div>
      </div>
      </div>
    </div>
    <div class="card border-1 mt-2">
      <div class="card">
        <h6 class="card-header" style="padding:4px;">Perfil de <i> Copy Number</i></h6>

        <div class="card-body p-3" style="background-color:white;">
          <div class="d-flex">
            <!-- Left: 85% width for the plot -->
            <div style="flex: 0 0 90%; max-width:90%;">
              <div id="scatter"><!-- SVG will be injected here at 900×300 --></div>
            </div>
        
            <!-- Right: 15% width for the filters -->
            <div style="flex: 0 0 10%; max-width:10%; padding-left:1rem;">
              <div id="scatter-controls" class="d-flex flex-column h-50" style="font-size:12px;">
                <!-- Chromosome selector -->
                <div class="mb-3">
                  <label for="chrFilter" class="form-label mb-1">Cromosoma</label>
                  <select id="chrFilter" class="form-select form-select-sm">
                    <option value="">Tots</option>
                    <!-- …populated by JS… -->
                  </select>
                </div>
                <!-- Coordinate range -->
                <div class="mb-3">
                  <label class="form-label mb-1">Coordenades</label>
                  <div class="input-group input-group-sm mb-1">
                    <input type="number" id="regionMin" class="form-control" placeholder="start">
                  </div>
                  <div class="input-group input-group-sm">
                    <input type="number" id="regionMax" class="form-control" placeholder="end">
                  </div>
                </div>
                <!-- Apply button at bottom -->
                <div class="mt-auto">
                  <button id="applyFilter" class="btn btn-outline-primary btn-sm w-30">Aplica</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        

      </div>
    </div>
    </div>
    <div class="tab-pane fade" id="QC" role="tabpanel" aria-labelledby="QC-tab">
      <div class="card card-body border-0 mt-1" style="outline-bottom: 1px solid grey;background-color:white;">
        <div class="row" style="font-size:16px;">
          <div class="col">
            <h5><b><i class="fas fa-angle-right" style="margin-bottom:15px;"></i> Mètriques Generals</b></h5>

            <table class="table table-hover table-sm ">
              <thead>
                <tr>
                    <th colspan="4"></th>
                    <th colspan="3">Call Rate</th>
                    <th colspan="3">Exons no coberts</th>
                </tr>
                <tr>
                    <th>N Reads (M)</th>
                    <th>Reads mapejats (M)</th>
                    <th>Cobertura mitja</th>
                    <th>Enrichment (%)</th>
                    <th>Duplicats PCR (%)</th>
                    <th>20X</th>
                    <th>30X</th>
                    <th>100X</th>
                    <th>20X</th>
                    <th>30X</th>
                    <th>100X</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding-right:20px;">{{ summary_qc_dict['TOTAL_READS']|float|round/10e5 }} </td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['MAPPED_READS']|float|round/10e5 }} ({{ summary_qc_dict['PCT_MAPPED_READS'] }}%)</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['MEAN_COVERAGE_TARGET'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['ROI_PERCENTAGE'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['PCT_PCR_DUPLICATES'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['CALL_RATE']['20X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['CALL_RATE']['30X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['CALL_RATE']['100X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['LOST_EXONS']['total']['20X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['LOST_EXONS']['total']['30X'] }}</td>
                  <td style="padding-right:20px;">{{ summary_qc_dict['LOST_EXONS']['total']['100X'] }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="row mt-3" style="font-size:16px;">
          <div class="col">
          <h5><b><i class="fas fa-angle-right" style="margin-bottom:15px;"></i> Trimming</b></h5>
          <table class="table table-hover table-sm ">
            <thead>
              <th>Long. Read1 (bp)</th>
              <th>Long. Read2 (bp)</th>
              <th>Reads amb adaptadors</th>
              <th>Bases totals (M)</th>
              <th>Bases trimmed (M)</th>
              <th>q20 Rate</th>
              <th>q30 Rate</th>
            </thead>
            <tbody>
              <tr>
                {% set total_bases_before = fastp_dict['summary']['before_filtering']['total_bases'] %}
                {% set total_bases_after = fastp_dict['summary']['after_filtering']['total_bases'] %}
                {% set bases_trimmed = total_bases_before-total_bases_after %}
                <td style="padding-right:20px;">{{ fastp_dict['summary']['after_filtering']['read1_mean_length'] }} </td>
                <td style="padding-right:20px;">{{ fastp_dict['summary']['after_filtering']['read2_mean_length'] }}</td>
                <td style="padding-right:20px;">{{ fastp_dict['adapter_cutting']['adapter_trimmed_reads'] }}</td>
                <td style="padding-right:20px;">{{ (total_bases_before/10e6)|round(3) }}</td>
                <td style="padding-right:20px;">{{ (bases_trimmed/10e6)|round(3) }}</td>
                <td style="padding-right:20px;">{{ (100*(fastp_dict['summary']['after_filtering']['q20_rate']))|float|round(3) }}</td>
                <td style="padding-right:20px;">{{ (100*(fastp_dict['summary']['after_filtering']['q30_rate']))|float|round(3) }}</td>
              </tr>
            </tbody>
          </table>
          </div>
        </div>
        <hr>

        <div class="row mt-3">
          <h5><b><i class="fas fa-angle-right" style="margin-left:15px;margin-bottom:15px;"></i> Qualitats per posició</b></h5>
        </div>
        <div class="row" style="font-size:16px;">
          <div class="col">
            <h6>Read1</h6>
            <div class="chart" id="scatter2">
              <script>
                  var graphs = {{plot_read1 | safe}};
                  Plotly.plot('scatter2',graphs,{});
              </script>
            </div>
          </div>
          <div class="col">
            <h6>Read2</h6>
            <div class="chart" id="scatter3">
              <script>
                  var graphs = {{plot_read2 | safe}};
                  Plotly.plot('scatter3',graphs,{});
              </script>
            </div>
          </div>
        </div>
        <hr>
        <div class="row mt-3">
          <h5><b><i class="fas fa-angle-right"></i> Adaptadors</b></h5>
        </div>
        <div class="row" style="font-size:16px;">
          <div class="col">
            <div class="chart" id="scatter4">
              <script>
                  var graphs = {{r1_adapters_plot | safe}};
                  Plotly.plot('scatter4',graphs,{});
              </script>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="Lost_Exons" role="tabpanel" aria-labelledby="Lost_Exons-tab">

      <div class="card card-body border-0 mt-1" style="outline-bottom: 1px solid grey;background-color:white;">
        <div class="row" style="font-size:16px;">
          <div class="col">
            <h5><b><i class="fas fa-angle-right" style="margin-bottom:15px;"></i> Exons no coberts</b></h5>
            <div class="table-responsive">
              <table id="lost_exons_table" class="table table-striped table-bordered wrap" style="width:100%;background-color:white;">
                <thead>
                  <th>Coordenades</th>
                  <th>Probe Group</th>
                  <th>Gene</th>
                  <th>Isoforma</th>
                  <th>N Exó/Roi</th>
                  <th>20X</th>
                  <th>30X</th>
                  <th>100X</th>
                </thead>
                <tbody>
                  {% for roi in summary_qc_dict['LOST_EXONS']['exons'] %}
                  {% set roi_dict = summary_qc_dict['LOST_EXONS']['exons'][roi] %}
                  {% if roi_dict['COV_THRESHOLD']['20X']|float == 100 %}
                    {% set cov20_color = 'white' %}
                  {% else %}
                    {% set cov20_color = '#ffb2b2' %}

                  {% endif %}
                  <tr>
                    <td style="padding-right:20px;">{{ roi_dict['CHROMOSOME'] }}:{{ roi_dict['START'] }}-{{ roi_dict['END'] }} </td>
                    <td style="padding-right:20px;">{{ roi_dict['PROBE_GROUP'] }}</td>
                    <td style="padding-right:20px;"><a href="https://www.genecards.org/cgi-bin/carddisp.pl?gene={{roi_dict['GENE_NAME']}} "><i>{{ roi_dict['GENE_NAME'] }}</i></a></td>
                    <td style="padding-right:20px;">{{ roi_dict['ENST_ID'] }}</td>
                    <td style="padding-right:20px;">{{ roi_dict['EXON_NUMBER'] }}</td>
                    <td style="padding-right:20px;background-color:{{cov20_color}}">{{ roi_dict['COV_THRESHOLD']['20X'] }}</td>
                    <td style="padding-right:20px;">{{ roi_dict['COV_THRESHOLD']['30X'] }}</td>
                    <td style="padding-right:20px;">{{ roi_dict['COV_THRESHOLD']['100X'] }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if active == "Therapeutic" %}
    <div class="tab-pane fade pt-2 show active" id="Therapeutic" role="tabpanel" aria-labelledby="Therapeutic-tab">
    {% else %}
    <div class="tab-pane fade pt-2 " id="Therapeutic" role="tabpanel" aria-labelledby="Therapeutic-tab">
    {% endif %}
        <div class="d-flex justify-content-center">
          <div class = "row mt-1">
              {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
              {% for category,message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show ml-3" role="alert">
                <span>{{ message }}</span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
                <br>
              </div>
              {% endfor %}
            {% endif %}
          {% endwith %}
          </div>
        </div>

        <div id="message_div" class="alert alert-success alert-dismissible fade show w-50" role="alert" style="margin:0 auto;display:none;">
            <span id="message_span"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <br>
        </div>

        <div style="margin-top:15px;background-color:#e8f4f8;width:100%;padding:10px;font-size:14px;">
          <form id="report_form">
            <div class="row">
              <div class="col-4">
                <input type="hidden" id="run_id" name="run_id" value="{{ sample_info.run_id }}">
                <input type="hidden" id="sample" name="sample" value="{{ sample_info.lab_id }}">
                <input type="hidden" id="sample_id" name="sample_id" value="{{ sample_info.lab_id }}">
                <input type="hidden" id="tumor_origin" name="tumor_origin" value="{{ petition_info.Tumour_origin }}">
                <input style="display:inline;" type="checkbox" id="substitute_report" name="substitute_report">
                <label style="display:inline;" for="substitute_report"> Marcar com a informe de substitució</label>
                <br>
                <input style="display:inline;" type="checkbox" id="lowqual_sample" name="lowqual_sample">
                <label style="display:inline;" for="lowqual_sample"> La mostra no compleix els criteris mínims de qualitat </label>
                <br>
                <input style="display:inline;" type="checkbox" id="no_enac" name="no_enac">
                <label style="display:inline;" for="no_enac"> Procediment no acreditat per ENAC </label>
                <br>
                <button type="submit" id="report_button" class="btn btn-secondary btn-sm mt-2">
                  <i class="fas fa-file-alt" style="color:white;"> </i> Generar informe
                </button>
              </div>
              <div class="col-8">
                <div class="row">
                  <div class="col" id="modificacions_container" style="display: none;">
                    <label for="repeat_notes">Llista de modificacions <small>(En cas de reemissió d'informe)</small>:</label>
                    <textarea class="form-control" id="repeat_notes" name="repeat_notes" rows="2"></textarea>
                  </div>
                  <div class="col">
                    <label for="comments">Altres comentaris de qualitat:</label>
                    <textarea class="form-control" id="comments" name="comments" rows="2"></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-5">
              </div>
              <div class="col-7">

              </div>
            </div>

          </form>
        </div>
        <hr>

        <div class="table-responsive-">

          <button type="button" id="new_variant_button" class="btn btn-primary btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#addEntryModal">
            <i class="fas fa-plus-circle" ></i> Afegir variant
          </button>
          <button class="btn btn-secondary btn-sm mb-1" id="copyButton" onclick="copyVariantInfo()"> <i class="fas fa-copy" ></i>Copiar variants</button>

          <table id="therapeutic_table" class="table table-sm table-striped table-bordered dt-responsive wrap" style="width:100%;background-color:white;">
            <div id="delete_multiple_button" style="margin-bottom:15px;display:none;">
              <hr>
              <a type="button" type="submit" id="" class="btn btn-light btn-sm" style="background-color:#FFEBCD;">
                <i class="fas fa-trash"></i> Elimina selecció
              </a>
            </div>
            <thead>
              <tr>
                <th></th>
                <th>Accions</th>
                <th>Gen</th>
                <th>Variant</th>
                <th>Bases de dades</th>
              </tr>
            </thead>
            <tbody>
            {% for var in relevant_variants %}
            {% set var_json = var.var_json  %}

            {% if var.blacklist == "yes" %}
              <tr style="background-color:rgb(255, 222, 222)"
              
              data-gene="{{ var.gene }}" 
              data-exon="{{ var.exon }}" 
              data-intron="{{ var.intron }}"
              data-refseq="{{ var.refseq }}" 
              data-isoform="{{ var.enst_id }}" 
              data-pcode="{{ var.hgvsp }}" 
              data-ccode="{{ var.hgvsc }}"
              data-read_support="{{ var.read_support }}"
              data-depth="{{ var.depth }}"
              
              >

            {% else %}
              <tr
              data-gene="{{ var.gene }}" 
              data-exon="{{ var.exon }}" 
              data-intron="{{ var.intron }}"
              data-refseq="{{ var.refseq }}" 
              data-isoform="{{ var.enst_id }}" 
              data-pcode="{{ var.hgvsp }}" 
              data-ccode="{{ var.hgvsc }}"
              data-read_support="{{ var.read_support }}"
              data-depth="{{ var.depth }}"
          
              
              >
            {% endif %}

            <td>
              <input type="checkbox" id="check_var_{{ var.hgvsg }}" name="check_therapeutic_variant"/>
            </td>
            <td>
              <div class="row">
                <div class="col">
                  {% if (var.variant_type == "Amplification" or var.variant_type == "Loss" or var.variant_type == "SV") %}
                  <a class="btn btn-outline-primary btn-sm disabled" href="">
                    <i class="fas fa-plus-circle fa"></i> Info
                  </a>
                  {% else %}
                  <a class="btn btn-outline-primary btn-sm" href="{{ url_for('show_therapeutic_details', run_id=sample_info.run_id, sample=sample_info.lab_id, entry_id=var.id, var_classification=var.classification) }} ">
                    <i class="fas fa-plus-circle fa"></i> Info
                  </a>
                  {% endif %}
                </div>
                <div class="col">
                  <a data-toggle="modal" data-target="#edit_report_{{var.id}}" role="button">
                    <i class="fas fa-edit" style="color:rgb(109, 106, 106)"></i><small></small>
                  </a>
                  <!-- <a class="" href="{{ url_for('remove_variant', run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, var_id=var.id, var_classification=var.classification) }}" onclick="return confirm('Segur que vols eliminar aquesta Variant?');" method="POST" enctype="multipart/form-data" id="update_therapeutic_variant"><i class="fas fa-trash" style="color: rgba(209, 20, 20, 0.938)"></i><small></small></a> -->



                  <a href="#"
                  class="delete-variant-btn text-danger"
                  data-url="{{ url_for('remove_variant',
                                        run_id=sample_info.run_id,
                                        sample=sample_info.lab_id,
                                        sample_id=sample_info.id,
                                        var_id=var.id,
                                        var_classification=var.classification) }}">
                 <i class="fas fa-trash"></i>
               </a>

                  <a onclick='showIgvVariant({{ var_json }});' role="button">
                    <div>
                      <i class="fas fa-image fa" style="border-radius:3px;margin:0px;padding:2px;color:white;background-color:#0d98ba"></i> <small><b>IGV</b></small>
                    </div>
                  </a>
                  {% if (var.blacklist == "yes") %}
                  <div class="row">
                    <div class="col">
                      <span class="badge badge-warning">
                        BLACKLIST
                      </span>
                    </div>
                  </div>
                  {% endif %}

                </div>               
              </div>

              <div class="modal fade bd-example-modal" id="edit_report_{{var.id}}" tabindex="-1" aria-labelledby="modal_edit_report_{{var.id}}" aria-hidden="true">
                <form action="{{ url_for('update_therapeutic_variant', run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, var_id=var.id, var_classification=var.classification) }}" method="POST" enctype="multipart/form-data" id="update_therapeutic_variant">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header" style="background-color:rgb(248, 248, 248);">
                        <h4 class="modal-title" id="modal_new_sample">Edita la variant {{ var.hgvsg }} </h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <div class="row mt-3 mb-3">
                          <div class="col">
                            <h6><b>Mou a:</b></h6>
                            <div class="custom-control custom-radio custom-control-inline">
                              <input type="radio" class="custom-control-input" name="variant_category" value="3" id="rare_variant_rare_{{var.id}}" checked>
                              <label class="custom-control-label" for="rare_variant_rare_{{var.id}}">
                                VUS
                              </label>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-sm">
                            <h6><b>Afegeix a la <i>Blacklist</i></b></h6>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-sm">
                            <div class="custom-control custom-checkbox">
                              {% if var.blacklist == "yes" %}
                              <input type="checkbox" style="background-color:green;" name="blacklist_check" value="blacklist" class="custom-control-input" id="blacklist_check_therapeutic_{{var.id}}" checked>
                              {% else %}
                              <input type="checkbox" style="background-color:green;" name="blacklist_check" value="blacklist" class="custom-control-input" id="blacklist_check_therapeutic_{{var.id}}">
                              {% endif %}
                              <label class="custom-control-label" for="blacklist_check_therapeutic_{{var.id}}">
                            </div>
                          </div>
                        </div>

                        </div>
                        <div class="d-flex justify-content-center align-items-center mt-2">
                          <button class="btn btn-primary mt-2 mb-2" style="width:15%;" type="submit" id="edit_therapeutic">Desa canvis</button>
                        </div>
                      </div>
                  </div>
                </form>
              </div>
            </td>
            <td style="min-width:60px;max-width:60px;">
                <div class="row">
                  <div class="col">
                    {% if (var.variant_type == "Amplification" or var.variant_type == "Loss" or var.variant_type == "SV") %}
                     <a><b><i>{{ var.gene }}</i></b></a>
                    {% else %}
                      <a href="https://www.genecards.org/cgi-bin/carddisp.pl?gene={{var.gene}} "><b><i>{{ var.gene }}</i></b></a>
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <!-- <i>{{ var.enst_id }}</i> -->
                    {{ var.refseq }}
                  </div>
                </div>
                <br>
                {% if var.exon != '.' %}
                  <b>Exó: </b>{{ var.exon }}
                {% else %}
                  <b>Intró: </b>{{ var.intron }}
                {% endif %}
              </td>
              <td style="min-width:220px;max-width:250px;">
                <div class="row">
                  <div class="col" id="{{ var.id }}" style="display:inline-block;" >
                    <span ><b>{{ var.hgvsp }}</b>
                    {% if var.tier_catsalut == "1" %}
                      <span class="badge badge-pill badge-danger">
                        Tier 1
                        <a onclick="loadTierModal(this);" class="link-light">
                         <i class="fas fa-edit" style="color:white;"></i>
                        </a>
                      </span>
                    {% elif var.tier_catsalut == "2" %}
                      <span class="badge badge-pill badge-success">
                        Tier 2
                        <a onclick="loadTierModal(this);" class="link-light">
                         <i class="fas fa-edit" style="color:white;"></i>
                        </a>
                      </span>
                    {% elif var.tier_catsalut == "3" %}
                      <span class="badge badge-pill badge-info">
                        Tier 3
                        <a onclick="loadTierModal(this);" class="link-light">
                         <i class="fas fa-edit" style="color:white;"></i>
                        </a>
                      </span>
                    {% else %}
                      <span class="badge badge-pill badge-secondary">
                        No tier
                        <a onclick="loadTierModal(this);" class="link-light">
                         <i class="fas fa-edit" style="color:white;"></i>
                        </a>
                      </span>
                    {% endif %}
                    </span>
                  </div>
                  <div class="col">
                      {% if (var.variant_type == "Amplification" or var.variant_type == "Loss") %}
                        <b>CN:</b> {{ var.allele_frequency }}
                      {% else %}
                        {% set read_support = var.read_support|int %}
                        {% set depth = var.depth|int %}
                        {% set vaf = 100*(read_support/depth)|float|round(5) %}
                        <b>VAF (%):</b> {{ '%0.3f'| format(vaf|float) }}
                      {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    {{ var.hgvsg }}
                  </div>
                  <div class="col">
                    <b>Read support:</b> {{ var.read_support }}
                  </div>
                 </div>
                <div class="row mb-2">
                  <div class="col">
                    {{ var.hgvsc }}
                  </div>
                  <div class="col">
                    <b>Profunditat: </b>{{ var.depth }}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <b> Tipus: </b> {{ var.variant_type }}
                  </div>
                  <!-- <div class="col">
                    <b>Max Pop AF: </b>{{ var.max_pop_af }}
                  </div> -->
                </div>

                <div class="row">
                  <div class="col">
                      <p class="text-truncate;word-wrap:break-word"><b> Localització/Efecte: </b> {{ var.consequence }}</p>
                  </div>
                  <div class="col">
                    <!-- <b>Max AF: </b>{{ var.max_af }} <br> -->
                    {% set var_db_freq = (100*(var.db_detected_number/var.db_sample_count))|float| round(2) %}
                    <b>Freq. DB: </b>{{ var_db_freq }}%  {{ var.db_detected_number }} de {{ var.db_sample_count }}
                  </div>
                </div>

                </div>
              </td>
              <td style="min-width:150px;max-width:250px;">
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.3" cy="12.3" r="10" stroke="darkorange" stroke-width="0.5" fill="darkorange" />
                      <text x="12.5" y="15" font-size="9" text-anchor="middle" fill="white" font-family="Comic Sans MS, sans-serif">
                        CGI 
                      </text>
                      <title>Cancer Genome Interpreter: Summary | CGI Prediction</title>
                    </svg>
                    {{ var.kb['Oncogenic summary'] }} | {{ var.kb['Oncogenic prediction'] }}
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.3" cy="12.3" r="10" stroke="#a1a1ce" stroke-width="0.5" fill="#a1a1ce" />
                      <text x="12.5" y="15" font-size="9" text-anchor="middle" fill="white" font-family="Comic Sans MS, sans-serif">
                        CV
                      </text>
                      <title>ClinVar: Germline | Somatic</title>
                    </svg>
                    {{ var.kb['ClinVar Germline']}} | {{ var.kb['ClinVar Somatic'] }}
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.5" cy="12.5" r="10" fill="none" stroke="#333c87" stroke-width="1.8" />
                      <circle cx="12.5" cy="12.5" r="6.5" fill="none" stroke="#333c87" stroke-width="1.8" />
                      <circle cx="12.5" cy="12.5" r="2.5" fill="#333c87" stroke="#333c87" stroke-width="1" />
                      <title>OncoKB</title>
                    </svg>                   
                    {{ var.kb['OncoKB'] }}
                    {% endif %}
                  </div>
                 </div>
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.3" cy="12.3" r="10" stroke="#333c87" stroke-width="0.5" fill="#333c87" />
                      <text x="12.5" y="15" font-size="12" text-anchor="middle" fill="white" font-family="Comic Sans MS, sans-serif">
                        F
                      </text>
                      <title>Franklink Germline | Somatic</title>
                    </svg>
                    {{ var.kb['Franklin ACMG'] }} | {{ var.kb['Franklin Oncogenicity'] }}
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    {% if var.kb %}
                    <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12.3" cy="12.3" r="10" stroke="orange" stroke-width="0.5" fill="orange" />
                      <text x="12.5" y="15" font-size="7" text-anchor="middle" fill="white" font-family="Comic Sans MS, sans-serif">
                        MTBP
                      </text>
                      <title>Molecular Tumor Board Portal</title>
                    </svg>
                    {{ var.kb['MTBP'] }}
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <small style="margin-left:0px;">                  
                      {% if var.kb %}
                      <b>Data de classificació: </b>  
                        {{ var.kb['Data Classificació'] }}
                      {% endif %}

                    </small>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
    </div>

    <div class="tab-pane fade pt-5" id="Rare" role="tabpanel" aria-labelledby="Rare-tab">

      <table id="rare_table" class="table table-sm table-striped table-bordered dt-responsive nowrap" style="width:100%;background-color:white;">
        <thead>
            <tr>
                <th></th>
                <th>Accions</th>
                <th>Gen</th>
                <th>Variant</th>
                <th>Altres</th>
            </tr>
        </thead>
        <tbody>
        {% for var in rare_variants %}
        <tr>
          <td>
            <div class="row">
              <div class="col">
                <a class="btn btn-outline-primary btn-sm" href="{{ url_for('show_therapeutic_details', sample=sample_info.lab_id, run_id=sample_info.run_id, entry_id=var.id, var_classification=var.classification) }} ">
                  <i class="fas fa-plus-circle fa"></i> Info
                </a>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col">
                <a data-toggle="modal" data-target="#edit_rare_report_{{var.id}}" role="button">
                  <i class="fas fa-edit" style="color:rgb(109, 106, 106)"></i><small></small>
                </a>
              </div>
              <div class="col">
                <a class="" href="{{ url_for('remove_variant', run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, var_id=var.id, var_classification=var.classification) }}" onclick="return confirm('Segur que vols eliminar aquesta variant?');" method="POST" enctype="multipart/form-data" id="update_therapeutic_variant"><i class="fas fa-trash" style="color: rgba(209, 20, 20, 0.938)"></i><small></small></a>
              </div>
              <div class="col">
              </div>
              <div class="col">
              </div>
            </div>
            <!-- <hr> -->
            <div class="row mt">
              <div class="col">
                <a data-toggle="modal" data-target="#show_igv{{var.id}}" role="button">
                  <div >
                    <i class="fas fa-image fa" style="border-radius:3px;margin:0px;padding:2px;color:white;background-color:#0d98ba"></i> <small><b>IGV</b></small>
                  </div>
                </a>
              </div>
            </div>

            <div class="modal fade bd-example-modal-lg" id="edit_rare_report_{{var.id}}" tabindex="-1" aria-labelledby="modal_edit_rare_report_{{var.id}}" aria-hidden="true">
              <form action="{{ url_for('update_therapeutic_variant', run_id=sample_info.run_id, sample=sample_info.lab_id, sample_id=sample_info.id, var_id=var.id, var_classification=var.classification) }}" method="POST" enctype="multipart/form-data" id="update_therapeutic_variant">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header" style="background-color:rgb(248, 248, 248);">
                      <h4 class="modal-title" id="modal_new_sample">Edita la variant {{ var.hgvsg }} </h4>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <div class="row mt-3 mb-3">
                        <div class="col">
                          <h6><b>Mou a:</b></h6>
                          <div class="custom-control custom-radio custom-control-inline">
                            <input type="radio" class="custom-control-input" name="variant_category" value="2" id="actionable_variant_rare_{{var.id}}">
                            <label class="custom-control-label" for="actionable_variant_rare_{{var.id}}">
                              Variants d'alt impacte
                            </label>
                          </div>
                          <!-- <div class="custom-control custom-radio custom-control-inline">
                            <input type="radio" class="custom-control-input" name="variant_category" value="3" id="rare_variant_rare_{{var.id}}" checked>
                            <label class="custom-control-label" for="rare_variant_rare_{{var.id}}">
                              VUS
                            </label>
                          </div> -->
                        </div>
                      </div>
                      <hr>

                      <div class="row">
                        <div class="col-sm">
                          <h6><b>Blacklist:</b></h6>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-sm">
                          <div class="custom-control custom-checkbox">
                            {% if var.blacklist == "yes" %}
                            <input type="checkbox" style="background-color:green;" name="blacklist_check" value="blacklist" class="custom-control-input" id="bioinfo_check_rare_{{var.id}}" checked>
                            {% else %}
                            <input type="checkbox" style="background-color:green;" name="blacklist_check" value="blacklist" class="custom-control-input" id="bioinfo_check_rare_{{var.id}}">
                            {% endif %}
                            <label class="custom-control-label" for="bioinfo_check_rare_{{var.id}}">
                          </div>
                        </div>
                      </div>
                      </div>
                      <div class="d-flex justify-content-center align-items-center mt-2">
                        <button class="btn btn-primary mt-2 mb-2" style="width:15%;" type="submit" id="edit_therapeutic">Desa canvis</button>
                      </div>
                    </div>
                </div>
              </form>
            </div>
          </td>
        <td>
            <div class="row">
              <div class="col-2">
                 <a href="https://www.genecards.org/cgi-bin/carddisp.pl?gene={{var.gene}} "><b><i>{{ var.gene }}</i></b></a>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <i>{{ var.enst_id }}</i>
              </div>
            </div>
            <br>
            {% if var.exon != '.' %}
              <b>Exó: </b>{{ var.exon }}
            {% else %}
              <b>Intró: </b>{{ var.intron }}
            {% endif %}
          </td>
          <td>
            <div class="row">
              <div class="col">
                <b>{{ var.hgvsp }}</b>
              </div>
            </div>
            <div class="row">
              <div class="col">
                {{ var.hgvsg }}
              </div>
            </div>
            <div class="row mb-2">
              <div class="col">
                {{ var.hgvsc }}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b> Tipus: </b> {{ var.variant_type }}
              </div>
            </div>
            <b> Localització/Efecte: <br></b> {{ var.consequence }}
            {% if (var.blacklist == "yes") %}
            <span class="badge badge-warning">
              BLACKLIST
            </span>
            {% endif %}
          </td>
          <td>
            <div class="row">
              <div class="col">

                {% set read_support = var.read_support|float %}
                {% set depth = var.depth|float %}
                <b>VAF (%):</b> {{ 100*(read_support/depth)|float|round(4)}}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b>Read support:</b> {{ var.read_support }}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b>Profunditat: </b>{{ var.depth }}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b>Max Pop AF: </b>{{ var.max_pop_af }}
              </div>
              <div class="col">
                <b>Max AF: </b>{{ var.max_af }}
              </div>
            </div>
            <div class="row">
              <div class="col">
                <b>Freq. DB: </b>{{ var.db_detected_number }} / {{ var.db_sample_count }}  {{ var.db_detected_freq |float | round(3) }}
              </div>
            </div>
          </td>
          <!-- <td>{{ var.therapies }}</td> -->
          <td>{{ var.tumor_type }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="tab-pane fade pt-5" id="CNA" role="tabpanel" aria-labelledby="CNA-tab">
      <table id="cnas_table" class="table table-sm table-striped table-bordered dt-responsive nowrap" style="width:100%;background-color:white;">
        <thead>
            <tr>
                <th>Chr</th>
                <th>Pos</th>
                <th>Alt</th>
                <th>Gens</th>
                <th>Tipus</th>
                <th>Ratio (log2)</th>
                <th>N Còpies</th>
                <th>N Rois</th>
            </tr>
        </thead>
        <tbody>
        {% for var in all_cnas %}
        <tr>
          <td>
            <div class="row">
              <div class="col">
                {{ var.chromosome }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.start }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.end }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.genes }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.svtype }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.ratio }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.cn }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.qual }}
              </div>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="tab-pane fade pt-5" id="Fusions" role="tabpanel" aria-labelledby="Fusion-tab">
      <table id="fusions_table" class="table table-sm table-striped table-bordered dt-responsive nowrap" style="width:100%;background-color:white;">
        <thead>
            <tr>
              <th>Chr</th>
              <th>Pos</th>
              <th>Alt</th>
              <th>Qual</th>
              <th>SV</th>
              <th>PR</th>
              <th>SR</th>
              <th>Prof.</th>
              <th>VAF</th>
              <th>Partners</th>
              <th>Flanking genes</th>
            </tr>
        </thead>
        <tbody>
        {% for var in all_fusions %}
        <tr>
          <td>
            <div class="row">
              <div class="col">
                {{ var.chromosome }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.start }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.end }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.qual }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.svtype }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.read_pairs }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.split_reads }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.depth }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.vaf | float | round(2) }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.fusion_partners }}
              </div>
          </td>
          <td>
            <div class="row">
              <div class="col">
                {{ var.flanking_genes  }}
              </div>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

</div>

{% block script %}


<script>
  const snvData     = {{ snv_data | safe }};
  const vafData     = {{ vaf_data | safe }};
  const consData    = {{ cons_data | safe }};
  const vartypeData = {{ vartype_data | safe }};
  const cnvData = {{ cnv_data | safe }};

</script>

<script>
 
 document.addEventListener('DOMContentLoaded', function(){
  // 1) Shared dimensions & margins
  const WIDTH  = 300, HEIGHT = 240;
  const M = { top:10, right:20, bottom:20, left:40 };

  // 2) Global tooltip div
  const tooltip = d3.select("body")
    .append("div")
    .attr("class","tooltip")
    .style("opacity",0);

  // ───────── SNV Bar Chart ─────────
  ;(function(){
  const data = Object.entries(snvData || {}).flatMap(([ref, alts]) =>
    Object.entries(alts || {}).map(([alt, cnt]) => ({ label:`${ref}>${alt}`, value:cnt }))
  );
  const W = 300 - M.left - M.right,
        H = 220 - M.top  - M.bottom;

  const svg = d3.select("#bar").append("svg")
      .attr("width", 360).attr("height", HEIGHT)
    .append("g")
      .attr("transform", `translate(${M.left},${M.top})`);

  const x = d3.scaleBand().domain(data.map(d=>d.label)).range([0,W]).padding(0.1);
  const y = d3.scaleLinear().domain([0, d3.max(data,d=>d.value)||1]).nice().range([H,0]);

   const ffpe = new Set(["C>T","G>A"]);

  svg.append("g")
   .attr("transform", `translate(0,${H})`)
   .call(d3.axisBottom(x))
   .call(g => g.selectAll("path, line").attr("stroke", "#555"))
   .call(g => g.selectAll("text")
    .attr("transform", "rotate(60)")    // rotate 60°
    .attr("dx", "0.8em")                // move label right
    .attr("dy", "0.15em")               // move label down a bit
    .style("text-anchor", "start")      // align text to the start of the tick
    .attr("fill", "#333"));

  svg.append("g")
    .call(d3.axisLeft(y).ticks(5))
    .call(g => g.selectAll("path, line").attr("stroke", "#555"))
    .call(g => g.selectAll("text").attr("fill",   "#333"));

  svg.selectAll("rect")
    .data(data).enter().append("rect")
      .attr("x",   d=> x(d.label))
      .attr("y",   d=> y(d.value))
      .attr("width",  x.bandwidth())
      .attr("height", d=> H - y(d.value))
      .attr("fill",  d=> ffpe.has(d.label)
                          ? "rgba(255,0,0,0.35)"
                          : "rgba(35,203,167,0.55)")
    .on("mouseover", function(event,d){
      tooltip.html(`${d.label}: <b>${d.value}</b>`)
        .style("left", (event.pageX+10)+"px")
        .style("top",  (event.pageY+10)+"px")
        .transition().duration(100).style("opacity",1);
      const px = x(d.label)+x.bandwidth()/2,
            py = y(d.value)-5;
      d3.select(this.parentNode).append("text")
        .attr("class","hover-label")
        .attr("x",px).attr("y",py)
        .attr("text-anchor","middle")
        .style("font-size","12px")
        .text(d.value);
    })
    .on("mouseout", function(){
      tooltip.transition().duration(100).style("opacity",0);
      d3.select(this.parentNode).selectAll(".hover-label").remove();
    });
})();


  // ───────── VAF Histogram ─────────
;(function(){
  // 1) bin the data into 20 buckets
  const bins = d3.bin()
    .domain([0,1])
    .thresholds(50)(vafData || []);

  const W = WIDTH - M.left - M.right;
  const H = 220 - M.top  - M.bottom;

  const svg = d3.select("#hist")
    .append("svg")
      .attr("width",  WIDTH)
      .attr("height", HEIGHT)
    .append("g")
      .attr("transform", `translate(${M.left},${M.top})`);

  // 2) scales
  const x = d3.scaleLinear().domain([0,1]).range([0, W]);
  const y = d3.scaleLinear()
    .domain([0, d3.max(bins, d=>d.length) || 1]).nice()
    .range([H, 0]);

  // 3) axes — note the .ticks(5) on the left axis!

  svg.append("g")
   .attr("transform", `translate(0,${H})`)
   .call(d3.axisBottom(x).ticks(5))
   .call(g => g.selectAll("path, line").attr("stroke", "#555"))
   .call(g => g.selectAll("text").attr("fill",   "#333"));

  svg.append("g")
    .call(d3.axisLeft(y).ticks(5))
    .call(g => g.selectAll("path, line").attr("stroke", "#555"))
    .call(g => g.selectAll("text").attr("fill",   "#333"));

  // 4) bars
  svg.selectAll("rect.hist-bar")
    .data(bins)
    .enter().append("rect")
      .attr("class","hist-bar")
      .attr("x",    d=> x(d.x0) + 1)
      .attr("y",    d=> y(d.length))
      .attr("width",d=> Math.max(0, x(d.x1) - x(d.x0) - 1))
      .attr("height",d=> H - y(d.length))
      .attr("fill","#89aacd")
    // 5) hover interactions
    .on("mouseover", function(event, d){
      if (!d || d.x0===undefined) return;
      tooltip.html(
          `[${d.x0.toFixed(2)}–${d.x1.toFixed(2)}]: <b>${d.length}</b>`
        )
        .style("left", (event.pageX+10)+"px")
        .style("top",  (event.pageY+10)+"px")
        .transition().duration(100)
        .style("opacity",1);
      const cx = (x(d.x0) + x(d.x1)) / 2;
      const cy = y(d.length) - 5;
      d3.select(this.parentNode).append("text")
        .attr("class","hover-label")
        .attr("x", cx).attr("y", cy)
        .attr("text-anchor","middle")
        .style("font-size","12px")
        .text(d.length);
    })
    .on("mouseout", function(){
      tooltip.transition().duration(100).style("opacity",0);
      d3.select(this.parentNode).selectAll(".hover-label").remove();
    });
})();
  // ───────── Consequence Donut + Legend ─────────


  ;(function(){
  // Shared dimensions
  const WIDTH  = 300,
        HEIGHT = 220;

  // 1) Prepare data
  const raw    = consData || {};
  const data   = Object.entries(raw).map(([label,value]) => ({ label, value }));
  if (!data.length) return;

  // 2) Compute legend width from the longest label
  const charWidth = 7; // approx px per character
  const maxChars  = d3.max(data, d => d.label.length);
  const LEG_W     = maxChars * charWidth + 30; // extra padding
  const TOTAL_W   = WIDTH + LEG_W + 20;        // extra margin
  const TOTAL_H   = HEIGHT;

  // 3) Clear and create SVG
  d3.select('#pie').selectAll('*').remove();
  const svg = d3.select('#pie')
    .append('svg')
      .attr('width',  TOTAL_W)
      .attr('height', TOTAL_H);

  // 4) Donut center group
  const cx = WIDTH/2,
        cy = HEIGHT/2;
  const g  = svg.append('g')
    .attr('transform', `translate(${cx},${cy})`);

  // 5) Radii
  const R      = 100,
        innerR = R * 0.35;

  // 6) Pie + Arc
  const pieGen   = d3.pie().value(d => d.value);
  const arcs     = pieGen(data);
  const arcGen   = d3.arc().innerRadius(innerR).outerRadius(R);

  // 7) Professional palette
  const color = d3.scaleOrdinal(d3.schemeSet3);

  // 8) Draw slices
  g.selectAll('path.slice')
    .data(arcs)
    .enter().append('path')
      .attr('class','slice')
      .attr('d', arcGen)
      .attr('fill', (d,i) => color(i))
    .on('mouseover', function(event,d){
      tooltip.html(`${d.data.label}: <b>${d.data.value}</b>`)
        .style('left', (event.pageX+10)+'px')
        .style('top',  (event.pageY+10)+'px')
        .transition().duration(100).style('opacity',1);
      const [lx,ly] = arcGen.centroid(d);
      g.append('text')
        .attr('class','hover-label')
        .attr('transform', `translate(${lx},${ly})`)
        .attr('text-anchor','middle')
        .style('font-size','12px')
        .text(d.data.value);
    })
    .on('mouseout', function(){
      tooltip.transition().duration(100).style('opacity',0);
      g.selectAll('.hover-label').remove();
    });

  // 9) Legend
  const legend = svg.append('g')
    .attr('transform', `translate(${WIDTH + 20}, 20)`);

  data.forEach((d,i) => {
    const row = legend.append('g')
      .attr('transform', `translate(0,${i * 20})`);
    row.append('rect')
      .attr('width', 12)
      .attr('height',12)
      .attr('fill', color(i));
    row.append('text')
      .attr('x', 16)
      .attr('y', 10)
      .text(d.label)
      .style('font-size','12px')
      .attr('alignment-baseline','middle');
  });
})();



// Function: createCNVScatter
function createCNVScatter(cnvData, config) {
  const {
    containerId,
    filterSelectId,
    minInputId,
    maxInputId,
    applyBtnId,
    width = 300,
    height = 300
  } = config;

  const M = { top:20, right:20, bottom:40, left:50 };
  const W = width  - M.left - M.right;
  const H = height - M.top  - M.bottom;

  // 1) Parse & sort baseData
  let baseData = cnvData.map(d => ({
    chromosome:   d.chromosome,
    region:       +d.region,
    pos:     +d.position,
    roi_log2:     +d.roi_log2,
    segment_log2: +d.segment_log2,
    gene:         d.gene || "",
    idx:          null
  }));

  const CHR_ORDER = [
    ...Array.from({length:22}, (_,i) => String(i+1)), // "1","2",…,"22"
    "X", "Y", "MT"
  ];

  // 2) Build a lookup map so lookups are O(1)
  const CHR_INDEX = CHR_ORDER.reduce((m, chr, i) => (m[chr] = i, m), {});

  // 3) When you sort, use that map (fallback to a high index for unknowns)
  baseData.sort((a, b) => {
    const ia = CHR_INDEX[a.chromosome] ?? CHR_ORDER.length;
    const ib = CHR_INDEX[b.chromosome] ?? CHR_ORDER.length;
    if (ia !== ib) return ia - ib;
    // same chromosome: sort by region
    return a.region - b.region;
  });

  // 2) Populate chromosome dropdown
  const uniqueChrs = [...new Set(baseData.map(d=>d.chromosome))];
  const chrFilter = document.getElementById(filterSelectId);
  uniqueChrs.forEach(chr => {
    const opt = document.createElement("option");
    opt.value = chr;
    opt.text  = chr;
    chrFilter.appendChild(opt);
  });

  // 3) Tooltip
  const tooltip = d3.select("body")
    .append("div")
      .attr("class","tooltip");

  // 4) Render function
  function renderPlot(data) {
    // a) assign idx
    data.forEach((d,i)=>d.idx=i);

    // b) group + compute blocks
    const byChr      = d3.group(data, d=>d.chromosome);
    const chromOrder = Array.from(byChr.keys());
    const blocks     = chromOrder.map(chr=>byChr.get(chr));
    const midpoints  = blocks.map(b=> (b[0].idx + b[b.length-1].idx)/2 );
    const boundaries = blocks.slice(1).map(b=> b[0].idx );

    // c) clear container
    d3.select("#"+containerId).selectAll("*").remove();

    // d) SVG
    const svg = d3.select("#"+containerId)
      .append("svg")
        .attr("width",  width)
        .attr("height", height)
      .append("g")
        .attr("transform",`translate(${M.left},${M.top})`);

    // e) scales
    const x = d3.scaleLinear().domain([0,data.length-1]).range([0,W]);
    const y = d3.scaleLinear()
      .domain(d3.extent(data.flatMap(d=>[d.roi_log2,d.segment_log2])))
      .nice()
      .range([H,0]);

    // f) axes
    svg.append("g")
      .call(d3.axisLeft(y).ticks(5))
      .call(g=>g.selectAll("path,line").attr("stroke","#555"))
      .call(g=>g.selectAll("text").attr("fill","#333"));

    svg.append("g")
      .attr("transform",`translate(0,${H})`)
      .call(
        d3.axisBottom(x)
          .tickValues(midpoints)
          .tickFormat((_,i)=> chromOrder[i])
      )
      .call(g=>g.selectAll("path,line").attr("stroke","#555"))
      .call(g=>g.selectAll("text").attr("fill","#333"));

    // g) boundaries
    svg.selectAll("line.boundary")
      .data(boundaries)
      .enter().append("line")
        .attr("x1",d=>x(d)).attr("x2",d=>x(d))
        .attr("y1",0).attr("y2",H)
        .attr("stroke","#999").attr("stroke-dasharray","3,2");

    // h) segment_log2 line
    const lineGen = d3.line()
      .x(d=>x(d.idx)).y(d=>y(d.segment_log2));
    svg.append("path")
      .datum(data)
      .attr("fill","none")
      .attr("stroke","red")
      .attr("stroke-width",1.5)
      .attr("d", lineGen);

    // i) alternating colors
    const palette = ["steelblue","grey"];
    const colorMap = {};
    chromOrder.forEach((chr,i)=> colorMap[chr] = palette[i % palette.length]);

    // j) ROI points
    svg.selectAll("circle.cnv-point")
      .data(data)
      .enter().append("circle")
        .attr("class","cnv-point")
        .attr("cx",d=>x(d.idx))
        .attr("cy",d=>y(d.roi_log2))
        .attr("r",3)
        .attr("fill",d=>colorMap[d.chromosome])
        .attr("opacity",0.8)
      .on("mouseover",function(event,d){
        tooltip.html(
            `<b><i>${d.gene}</i></b><br>`+
            `${d.chromosome}:${d.pos}<br>`+
            `ROI log2: <b>${d.roi_log2.toFixed(2)}</b><br>`+
            `Seg log2: <b>${d.segment_log2.toFixed(2)}</b><br>`
          )
          .style("left",(event.pageX+10)+"px")
          .style("top",(event.pageY+10)+"px")
          .transition().duration(100).style("opacity",1);
        d3.select(this.parentNode)
          .append("text")
            .attr("class","hover-label")
            .attr("x", x(d.idx)+6)
            .attr("y", y(d.roi_log2)-6)
            .style("font-size","10px")
            .text(d.roi_log2.toFixed(2));
      })
      .on("mouseout",function(){
        tooltip.transition().duration(100).style("opacity",0);
        svg.selectAll(".hover-label").remove();
      });

    // k) axis titles
    svg.append("text")
      .attr("x",W/2).attr("y",H+35)
      .attr("text-anchor","middle")
      .style("font-size","12px");
    svg.append("text")
      .attr("transform","rotate(-90)")
      .attr("x",-H/2).attr("y",-35)
      .attr("text-anchor","middle")
      .style("font-size","12px")
      .text("log₂ ratio");
  }

  // 5) Initial draw
  renderPlot(baseData);

  // 6) Hook up filter
  document.getElementById(applyBtnId)
    .addEventListener("click", ()=>{
      const selChr = document.getElementById(filterSelectId).value;
      const minR   = parseFloat(document.getElementById(minInputId).value);
      const maxR   = parseFloat(document.getElementById(maxInputId).value);
      const filtered = baseData.filter(d=>{
        if (selChr && d.chromosome!==selChr) return false;
        if (!isNaN(minR) && d.region<minR)   return false;
        if (!isNaN(maxR) && d.region>maxR)   return false;
        return true;
      });
      renderPlot(filtered);
    });
}

// Finally, invoke it:
createCNVScatter(cnvData, {
  containerId:   'scatter',
  filterSelectId:'chrFilter',
  minInputId:    'regionMin',
  maxInputId:    'regionMax',
  applyBtnId:    'applyFilter',
  width:         1300,
  height:        270
});

}); // end DOMContentLoaded

</script>


<script>

document.addEventListener('DOMContentLoaded', () => {
  // Attach a click‐handler to every delete button
  document.querySelectorAll('.delete-variant-btn')
    .forEach(btn => btn.addEventListener('click', handleDeleteVariant));
});

async function handleDeleteVariant(event) {
  event.preventDefault();
  const btn = event.currentTarget;

  // 1) confirm
  if (!confirm('Segur que vols eliminar aquesta variant?')) return;

  const url = btn.getAttribute('data-url');

  try {
    // 2) fire off AJAX POST
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

    // 3) parse JSON
    const { status, message, deleted_var_id } = await resp.json();
    if (status !== 'ok') throw new Error(message);

    // 4) show flash message in your #message_div
    const msgDiv  = document.getElementById('message_div');
    const msgSpan = document.getElementById('message_span');
    msgSpan.textContent = message;
    msgDiv.style.display = 'block';

    // 5) remove the <tr> containing this button
    const row = btn.closest('tr');
    if (row) row.remove();

  } catch (err) {
    console.error('Deletion failed:', err);
    alert('Error eliminant la variant. Torna-ho a provar.');
  }
}


button_new_variant = document.getElementById("new_variant_button");
button_new_variant.addEventListener("click", openNewVariantModal);


function openNewVariantModal() {
    // document.getElementById('lab_id').value = document.getElementById('edit_lab_id').innerText;
    // document.getElementById('run_id').value = document.getElementById('run_id_tag').innerText;
    // document.getElementById('edit_ext2_id').value = document.getElementById('edit_ext2_id').innerText;
    // document.getElementById('edit_ext3_id').value = document.getElementById('edit_ext3_id').innerText;
    $("#addVariantModal").modal('show');
}


// Handle form submission
const addVariantForm = document.getElementById('addVariantForm');
addVariantForm.addEventListener('submit', async (event) => {
    event.preventDefault(); // Prevent default form submission

    const formData = {
        lab_id: document.getElementById('edit_lab_id').innerText || '.',
        run_id: document.getElementById('run_id_tag').innerText || '.',
        ext1_id: document.getElementById('edit_ext2_id').value || '.',
        ext2_id: document.getElementById('edit_ext3_id').value || '.',
        gene: document.getElementById('gene').value || '.',
        enst_id: document.getElementById('new_enst_id').value || '.',
        hgvsg: document.getElementById('hgvsg').value || '.',
        hgvsc: document.getElementById('hgvsc').value || '.',
        hgvsp: document.getElementById('hgvsp').value || '.',
        variant_type: document.getElementById('variant_type').value || '.',
        exon: document.getElementById('exon').value || '.',
        intron: document.getElementById('intron').value || '.',
        depth: document.getElementById('depth').value || '.',
        allele_frequency: document.getElementById('allele_frequency').value || '.',
        read_support: document.getElementById('read_support').value || '.',
        tier_catsalut: document.getElementById('tier_catsalut').value || '.',
        classification: "Therapeutic",
        consequence: document.getElementById('edit_ext2_id').value || '.',
    };

    try {
        const response = await fetch('/add_new_variant', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        response.json().then((data) => {
            $("#addVariantModal").modal('hide');
            document.getElementById("message_div").style.display = "block";
            document.getElementById("message_span").innerHTML = data["info"] || "Success";
            console.log(data["info"] || "Success");
        }).then(() => {
            window.location.reload();
        }); // Reset the form
    } catch (error) {
        alert('Error adding entry: ' + error.message);
    }
});


document.getElementById('depth').addEventListener('input', calculateAlleleFrequency);
document.getElementById('read_support').addEventListener('input', calculateAlleleFrequency);

function calculateAlleleFrequency() {
    const depth = parseFloat(document.getElementById('depth').value);
    const readSupport = parseFloat(document.getElementById('read_support').value);

    if (!isNaN(depth) && depth > 0 && !isNaN(readSupport) && readSupport >= 0) {
        const alleleFrequency = Math.min(readSupport / depth, 1).toFixed(4); // Ensure max is 1
        document.getElementById('allele_frequency').value = alleleFrequency;
    } else {
        document.getElementById('allele_frequency').value = '';
    }
}

  document.getElementById('substitute_report').addEventListener('change', function() {
    var modificacionsContainer = document.getElementById('modificacions_container');
    if (this.checked) {
      modificacionsContainer.style.display = 'block';
    } else {
      modificacionsContainer.style.display = 'none';
    }
  });

  function updatePatient() {   
    edit_lab_id = document.getElementById("edit_lab_id").innerText;
    edit_modulab_id = document.getElementById("edit_modulab_id").innerText;
    edit_ext2_id = document.getElementById("edit_ext2_id").innerText;
    edit_ext3_id = document.getElementById("edit_ext3_id").innerText;

    edit_sample_type = document.getElementById("edit_sample_type").innerText;
    edit_recieved_date = document.getElementById("edit_recieved_date").innerText;
    edit_tumoral_pct = document.getElementById("edit_tumoral_pct").innerText;
    edit_hospital = document.getElementById("edit_hospital").innerText;
    edit_physician = document.getElementById("edit_physician_name").innerText;
    edit_biopsy_date = document.getElementById("edit_biopsy_date").innerText;
    edit_tumor_origin = document.getElementById("edit_tumor_origin").innerText;
    edit_age = document.getElementById("edit_age").innerText;
    edit_sex = document.getElementById("edit_sex").innerText;
    edit_sample_block = document.getElementById("edit_sample_block").innerText;
    edit_service = document.getElementById("edit_service").innerText;

    myarr = edit_biopsy_date.split("/");
    if (myarr.length == 3) {
      biopsy_date = myarr[2]+"-"+myarr[1]+"-"+myarr[0];
    }
    else {
      biopsy_date = edit_biopsy_date
    }


    myarr = edit_recieved_date.split("/");

    if (myarr.length == 3) {
      recieved_date = myarr[2]+"-"+myarr[1]+"-"+myarr[0];
    }
    else {
      recieved_date = edit_recieved_date
    }


    document.getElementById("modal_edit_lab_id").value = edit_lab_id;
    document.getElementById("modal_edit_modulab_id").value = edit_modulab_id;
    document.getElementById("modal_edit_ext2_id").value = edit_ext2_id;
    document.getElementById("modal_edit_ext3_id").value = edit_ext3_id;
    document.getElementById("modal_edit_sample_type").value = edit_sample_type;
    document.getElementById("modal_edit_hospital").value = edit_hospital;
    document.getElementById("modal_edit_physician_name").value = edit_physician;
    document.getElementById("modal_edit_biopsy_date").value = biopsy_date;
    document.getElementById("modal_edit_recieved_date").value = recieved_date;
    document.getElementById("modal_edit_tumor_origin").value = edit_tumor_origin;
    document.getElementById("modal_edit_age").value = edit_age;
    document.getElementById("modal_edit_sex").value = edit_sex;

    document.getElementById("modal_edit_sample_block").value = edit_sample_block;
    document.getElementById("modal_edit_service").value = edit_service;


    if (edit_tumoral_pct != ".") {
      edit_tumoral_pct = edit_tumoral_pct.replace("%", "");
      document.getElementById("modal_edit_tumoral_pct").value = edit_tumoral_pct;
    }
    $('#edit_sample').modal('show');
  }


  button_tier_modal = document.getElementById("change_sample_info_button");
  button_tier_modal.addEventListener("click", updatePatient2);

  function updatePatient2() {
    lab_id = document.getElementById("modal_edit_lab_id").value;
    modulab_id = document.getElementById("modal_edit_modulab_id").value;
    // ap_id = document.getElementById("modal_edit_ext1_id").value;
    hc_id = document.getElementById("modal_edit_ext2_id").value;
    cip_id = document.getElementById("modal_edit_ext3_id").value;
    sample_type = document.getElementById("modal_edit_sample_type").value;
    hospital = document.getElementById("modal_edit_hospital").value;
    tumor_pct =  document.getElementById("modal_edit_tumoral_pct").value;
    physician_name = document.getElementById("modal_edit_physician_name").value;
    tumor_origin = document.getElementById("modal_edit_tumor_origin").value;

    recieved_date = document.getElementById("modal_edit_recieved_date").value;
    biopsy_date = document.getElementById("modal_edit_biopsy_date").value;

    if (biopsy_date) {
      let tmp = biopsy_date.split("-");
      biopsy_date = tmp[2] + "/" + tmp[1] + "/" +tmp[0];
    }

    if (recieved_date) {
      let tmp = recieved_date.split("-");
      recieved_date = tmp[2] + "/" + tmp[1] + "/" +tmp[0];
    }


    sex = document.getElementById("modal_edit_sex").value; 
    age = document.getElementById("modal_edit_age").value; 

    sample_block = document.getElementById("modal_edit_sample_block").value;
    service = document.getElementById("modal_edit_service").value;

    old_lab_id = document.getElementById("edit_lab_id").innerText;
    old_ext1_id = document.getElementById("edit_lab_id").innerText;
    run_id = document.getElementById("run_id_tag").innerText;

    let data_json = {
      run_id: run_id,
      old_lab_id: old_lab_id,
      old_ext1_id: old_ext1_id,
      lab_id: lab_id,
      modulab_id: modulab_id,
      ext1_id: lab_id,
      ext2_id: hc_id,
      ext3_id: cip_id,
      sample_type: sample_type,
      hospital: hospital,
      tumor_pct: tumor_pct,
      physician_name: physician_name,
      recieved_date: recieved_date,
      biopsy_date: biopsy_date,
      tumor_origin: tumor_origin,
      sex: sex,
      age: age,
      sample_block: sample_block,
      service: service
    }

    fetch('/update_patient_info', {
      method: "POST",
      headers: {
        'Content-Type': 'application/json'
      },
      body:JSON.stringify(data_json)
    })
    .then((response) => response.json())
    .then((data) => {
      document.getElementById("message_div").style.display = "block";
      document.getElementById("message_span").innerHTML = data["info"];
      console.log(data["info"]);
      $('#edit_sample').modal('hide');
    }).then(() => {
      //window.location.reload();

      document.getElementById("edit_lab_id").innerText = lab_id;
      document.getElementById("edit_modulab_id").innerText = modulab_id;
      document.getElementById("edit_ext2_id").innerText = hc_id;
      document.getElementById("edit_ext3_id").innerText = cip_id;
      document.getElementById("edit_sample_type").innerText = sample_type;
      document.getElementById("edit_recieved_date").innerText = recieved_date;

      document.getElementById("edit_tumoral_pct").innerText = tumor_pct;
      document.getElementById("edit_hospital").innerText = hospital;


      document.getElementById("edit_physician_name").innerText = physician_name;
      document.getElementById("edit_biopsy_date").innerText = biopsy_date;
      document.getElementById("edit_tumor_origin").innerText = tumor_origin;
      document.getElementById("edit_age").innerText = age;
      document.getElementById("edit_sex").innerText = sex;
      document.getElementById("edit_sample_block").innerText = sample_block;
      document.getElementById("edit_service").innerText = service;
      document.getElementById("lab_id_tag").innerText = lab_id;

      let sample_num_id = document.getElementById("sample_num_id").innerText;

      const baseUrl = window.location.origin;  // e.g., "http://172.16.83.24:5000"
      const newPath = `/show_sample_details/${run_id}/${lab_id}/${sample_num_id}/General`;
      const newUrl = baseUrl + newPath;

      window.history.pushState({ path: newUrl }, '', newUrl);


    });


  }


  function loadTierModal(event) {

    tier = event.parentElement.innerText;
    var_id = event.parentElement.parentElement.parentElement.id;
    tier_modal = document.getElementById("tier_modal");
    modal_var_id = document.getElementById("modal_var_id").innerText = var_id;
    document.getElementById("tier_1").checked = false;
    document.getElementById("tier_2").checked = false;
    document.getElementById("tier_3").checked = false;
    document.getElementById("no_tier").checked = false;

    if (tier.includes("1")) {
       document.getElementById("tier_1").checked = true;
    }
    if (tier.includes("2")) {
      document.getElementById("tier_2").checked = true;
    }
    if (tier.includes("3")) {
      document.getElementById("tier_3").checked = true;
    }
    if (tier.includes("3")) {
      document.getElementById("tier_3").checked = true;
    }
    if (tier.includes("No")) {
      document.getElementById("no_tier").checked = true;
    }
    $('#tier_modal').modal('show');
    console.log(tier);
  }

  button_tier_modal = document.getElementById("change_tier_button");
  button_tier_modal.addEventListener("click", modifyTierModal);
  function modifyTierModal() {
    let tier = document.querySelector('input[name="change_tier[]"]:checked').value;
    let modal_var_id = document.getElementById("modal_var_id").innerText;
    let body_data = {
      "tier": tier,
      "var_id": modal_var_id
    }

    fetch('/modify_tier', {
      method: "POST",
      headers: {
        'Content-Type': 'application/json'
      },
      body:JSON.stringify(body_data)
    })
    .then((response) => response.json())
    .then((data) => {
      document.getElementById("message_div").style.display = "block";
      document.getElementById("message_span").innerHTML = data["info"];
      console.log(data["info"]);
      $('#tier_modal').modal('hide');
    }).then(() => {
            window.location.reload();
        });
  }


  function showIgvVariant(locus) {
    // var start = parseInt(locus['POS']) +2;
    // var coordinates = locus['CHROM'] + ':' + start.toString();

    var start = parseInt(locus['POS']);
    var coordinates = locus['CHROM'] + ':' + start.toString();

    console.log(coordinates);

    var igvDiv = document.getElementById('igvDiv');
    igvDiv.innerHTML = "";
    igv.removeAllBrowsers();

    $('#show_igv').modal('show');

    igvDiv.innerHTML = `<div id="igv_lodader"><span  class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Carregant IGV...</div>`;
    var options =
      {
          locus: coordinates,
          genome: "hg19",
          showCenterGuide: true,
          tracks:[
            {
              type:'alignment',
              format: 'bam',
              url : "{{ url_for('download_sample_bam', run_id=sample_info.run_id, sample=sample_info.lab_id) }}" ,
              indexURL: "{{ url_for('download_sample_bai', run_id=sample_info.run_id, sample=sample_info.lab_id) }}"
            }
          ]
      };
      setTimeout(function(){
        igv.createBrowser(igvDiv, options)
            .then(function (browser) {
                document.getElementById('igv_lodader').remove();
                igv.browser = browser;
                console.log("Created IGV browser");
            });
    }, 3000);

  }


  var report_form = document.forms.namedItem("report_form");
  report_form.addEventListener('submit', generateReport, false);

  function generateReport(event) {
     report_button = document.getElementById('report_button');
     report_button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generant informe...`;

     let formData = new FormData(document.forms.namedItem("report_form"));

     ms = document.getElementById("message_span");
     if (ms) {
       ms.innerHTML = "";
     }

     var request = new XMLHttpRequest();
     request.open("POST", "/create_somatic_report", true);
     request.onload = function(oEvent) {
       if (request.status == 200) {
         var response_json = JSON.parse(request.responseText);
         var display_message = response_json.message_text;
         report_button.innerHTML = `<i class="fas fa-file-alt" style="color:white;"> </i> Generar informe`;

         document.getElementById("message_div").style.display = "block";
         document.getElementById("message_span").innerHTML = "Nou informe generat correctament!";

       }
       else {
         console.log("error")
       }
     };
     request.send(formData);
     event.preventDefault();
   }

  function selectAllVariants() {

     var check_all_therapeutic = $('#check_all_therapeutic').prop('checked');
     if (check_all_therapeutic == true) {
       $('input[name="check_therapeutic_variant"]').each(function() {
     			this.checked = true;
     		});
        $('#delete_multiple_button').show();
     }
     else {
       $('input[name="check_therapeutic_variant"]').each(function() {
     			this.checked = false;
     		});
       $('#delete_multiple_button').hide();
     }
   }

// Diccionari per convertir codis d'aminoàcids de tres lletres a una lletra
var aminoDict = {
  "Ala": "A",
  "Arg": "R",
  "Asn": "N",
  "Asp": "D",
  "Cys": "C",
  "Glu": "E",
  "Gln": "Q",
  "Gly": "G",
  "His": "H",
  "Ile": "I",
  "Leu": "L",
  "Lys": "K",
  "Met": "M",
  "Phe": "F",
  "Pro": "P",
  "Ser": "S",
  "Thr": "T",
  "Trp": "W",
  "Tyr": "Y",
  "Val": "V",
  "Ter": "*",// Stop codon
  "?": "?" 
};


// Function to convert a long amino acid change to short notation
function convertLongToShort(longChange) {
  // Remove "p." prefix if present
  if (longChange.startsWith("p.")) {
    longChange = longChange.substring(2).trim();
  }
  
  // If the change contains "fs", process as frameshift
  if (longChange.includes("fs")) {
    // Split at "fs"
    var parts = longChange.split("fs");
    if (parts.length !== 2) return longChange; // Fallback if unexpected format
    var leftPart = parts[0];  // e.g., "Thr1556Asn"
    var rightPart = parts[1]; // e.g., "Ter3"
    
    // Process leftPart: expect format [AminoLeft][Number][AminoRight]
    var patternLeft = /^([A-Za-z]+)(\d+)([A-Za-z]+)$/;
    var matchLeft = leftPart.match(patternLeft);
    if (!matchLeft) return longChange;
    var leftAA = matchLeft[1];   // e.g., "Thr"
    var pos = matchLeft[2];      // e.g., "1556"
    var nextAA = matchLeft[3];   // e.g., "Asn"
    
    // Convert left amino acids in 3-letter chunks
    var leftShort = "";
    for (var i = 0; i < leftAA.length; i += 3) {
      var chunk = leftAA.substr(i, 3);
      chunk = chunk.charAt(0).toUpperCase() + chunk.slice(1).toLowerCase();
      leftShort += aminoDict[chunk] || chunk;
    }
    var nextShort = "";
    for (var i = 0; i < nextAA.length; i += 3) {
      var chunk = nextAA.substr(i, 3);
      chunk = chunk.charAt(0).toUpperCase() + chunk.slice(1).toLowerCase();
      nextShort += aminoDict[chunk] || chunk;
    }
    
    // Process rightPart, expected to be something like "Ter3"
    var patternRight = /^([A-Za-z]+)(\d+)$/;
    var matchRight = rightPart.match(patternRight);
    var rightSuffix = "";
    if (matchRight) {
      var stopAA = matchRight[1];
      var stopNum = matchRight[2];
      stopAA = stopAA.charAt(0).toUpperCase() + stopAA.slice(1).toLowerCase();
      rightSuffix = (aminoDict[stopAA] || stopAA) + stopNum;
    } else {
      rightSuffix = rightPart; // fallback if unexpected
    }
    
    // Final frameshift short notation: leftShort + pos + nextShort + "fs" + rightSuffix
    return leftShort + pos + nextShort + "fs" + rightSuffix;
  } else {
    // Normal (non-frameshift) case: expected format [AminoLeft][Number][AminoRight]
    var pattern = /^([A-Za-z]+)(\d+)([A-Za-z]+)$/i;
    var match = longChange.match(pattern);
    if (!match) return longChange;
    var left = match[1];
    var pos = match[2];
    var right = match[3];
    
    var leftShort = "";
    for (var i = 0; i < left.length; i += 3) {
      var chunk = left.substr(i, 3);
      chunk = chunk.charAt(0).toUpperCase() + chunk.slice(1).toLowerCase();
      leftShort += aminoDict[chunk] || chunk;
    }
    
    var rightShort = "";
    for (var i = 0; i < right.length; i += 3) {
      var chunk = right.substr(i, 3);
      chunk = chunk.charAt(0).toUpperCase() + chunk.slice(1).toLowerCase();
      rightShort += aminoDict[chunk] || chunk;
    }
    
    return leftShort + pos + rightShort;
  }
}


// Funció principal per copiar la informació de totes les files de la taula
function copyVariantInfo() {
  const tableElement = document.getElementById("therapeutic_table");
  const button = document.getElementById("copyButton");
  
  // Comprovem si la taula està inicialitzada com a DataTable
  if ($.fn.DataTable.isDataTable(tableElement)) {
    const table = $('#therapeutic_table').DataTable();
    const originalPageLength = table.page.len();
    
    // Adjunta l'escoltador de l'esdeveniment 'draw' ABANS de canviar la paginació
    table.one('draw', function() {
      // Recupera totes les files ara visibles (incloent les ocultes)
      const rows = Array.from(table.rows().nodes());
      let infoList = [];
      
      rows.forEach(row => {
        const gene = row.getAttribute('data-gene');
        const exon = row.getAttribute('data-exon');
        const intron = row.getAttribute('data-intron');
        const isoform = row.getAttribute('data-isoform');
        const refseq = row.getAttribute('data-refseq');
        const pcode = row.getAttribute('data-pcode'); // canvi llarg, per exemple "Val560Glu"
        const ccode = row.getAttribute('data-ccode');
        const readSupport = parseFloat(row.getAttribute('data-read_support'));
        const depth = parseFloat(row.getAttribute('data-depth'));
  
        let vaf = "";
        if (depth && readSupport) {
          vaf = (100 * (readSupport / depth)).toFixed(2);
        }
  
        // Decideix si utilitzar "exó" o "intró" segons quin camp tingui dades (si exon no és ".")
        let intronExon = ".";
        if (exon !== ".") {
          intronExon = "exó";
        }
        if (intron !== ".") {
          intronExon = "intró";
        }
  
        // Extreu el valor numèric inicial de l'exon/intró (per exemple, "21" de "exó 21/21")
        let exonText = (exon && exon !== '.') ? `exó ${exon}` : `intró ${intron}`;
        let firstValue = "";
        if (exonText.includes(" ")) {
          let parts = exonText.split(' ');
          if (parts.length > 1) {
            firstValue = parts[1].split('/')[0];
          }
        }
  
        // Converteix el canvi llarg al seu format curt
        const shortPcode = convertLongToShort(pcode);
        let displayPcode = ".";
        let longPcodeRaw = pcode.startsWith("p.") ? pcode.substring(2) : pcode;
        if (exon != ".") {
          displayPcode = "p.(" + longPcodeRaw + ")";
        }

        // Construeix la cadena final, incloent el canvi llarg i el seu equivalent curt
        // Exemple: "GENE: exó 21(ISOFORM); Val560Glu (V560E); ccode. VAF:33.27%"
        const info = `${gene} (${refseq}) ${intronExon} ${firstValue}: ${ccode}; ${displayPcode}.[${shortPcode}] VAF:${vaf}%`;
        infoList.push(info);
      });
  
      const finalInfo = infoList.join("\n");
  
      // Copia al clipboard utilitzant la Clipboard API (o fallback)
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(finalInfo)
          .then(() => {
            updateButtonTick(button);
            // Restaura la paginació original
            table.page.len(originalPageLength).draw();
          })
          .catch(err => {
            console.error("Clipboard API error:", err);
            fallbackCopyTextToClipboard(finalInfo, function() {
              updateButtonTick(button);
              table.page.len(originalPageLength).draw();
            });
          });
      } else {
        fallbackCopyTextToClipboard(finalInfo, function() {
          updateButtonTick(button);
          table.page.len(originalPageLength).draw();
        });
      }
    });
    
    // Canvia la paginació per mostrar totes les files
    table.page.len(-1).draw();
  
  } else {
    // Si no és DataTable, simplement processa tots els <tr> amb data-gene
    const rows = document.querySelectorAll('tr[data-gene]');
    let infoList = [];
    
    rows.forEach(row => {
      const gene = row.getAttribute('data-gene');
      const exon = row.getAttribute('data-exon');
      const intron = row.getAttribute('data-intron');
      const isoform = row.getAttribute('data-isoform');
      const pcode = row.getAttribute('data-pcode');
      const ccode = row.getAttribute('data-ccode');
      const readSupport = parseFloat(row.getAttribute('data-read_support'));
      const depth = parseFloat(row.getAttribute('data-depth'));
  
      let vaf = "";
      if (depth && readSupport) {
        vaf = (100 * (readSupport / depth)).toFixed(2);
      }
  
      let intronExon = ".";
      if (exon !== ".") {
        intronExon = "exó";
      }
      if (intron !== ".") {
        intronExon = "intró";
      }
  
      let exonText = (exon && exon !== '.') ? `exó ${exon}` : `intró ${intron}`;
      let firstValue = "";
      if (exonText.includes(" ")) {
        let parts = exonText.split(' ');
        if (parts.length > 1) {
          firstValue = parts[1].split('/')[0];
        }
      }
      let displayPcode = ".";
      let longPcodeRaw = pcode.startsWith("p.") ? pcode.substring(2) : pcode;
      if (exon !== ".") {
        displayPcode = "p.(" + longPcodeRaw + ")";
      }
  
      const shortPcode = convertLongToShort(pcode);
      const info = `${gene} (${isoform}) ${intronExon} ${firstValue}: ${ccode}; ${displayPcode}.[${shortPcode}] VAF:${vaf}%`;
      infoList.push(info);
    });
    const finalInfo = infoList.join("\n");
  
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(finalInfo)
        .then(() => updateButtonTick(button))
        .catch(err => {
          console.error("Clipboard API error:", err);
          fallbackCopyTextToClipboard(finalInfo, function() {
            updateButtonTick(button);
          });
        });
    } else {
      fallbackCopyTextToClipboard(finalInfo, function() {
        updateButtonTick(button);
      });
    }
  }
}
  
// Fallback que utilitza un textarea temporal per copiar el text al clipboard
function fallbackCopyTextToClipboard(text, callback) {
  const button = document.getElementById("copyButton");
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed";
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.opacity = "0";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      // En lloc d'un alert, actualitzem el botó afegint una icona tick de Font Awesome
      updateButtonTick(button);
    }
  } catch (err) {
    console.error("Fallback error:", err);
  }
  
  document.body.removeChild(textArea);
  
  if (callback && typeof callback === 'function') {
    callback();
  }
}
  
// Funció per actualitzar el botó amb una icona tick (Font Awesome)
function updateButtonTick(button) {
  if (button) {
    // Guarda el contingut original del botó si no està guardat
    if (!button.getAttribute('data-original-text')) {
      button.setAttribute('data-original-text', button.innerHTML);
    }
    // Actualitza el contingut del botó per mostrar una icona tick
    button.innerHTML = "";
    button.innerHTML += ' <i class="fas fa-check"></i>';
    
    // Opcional: es pot revertir el botó al contingut original després de 2 segons
    setTimeout(function() {
      button.innerHTML = button.getAttribute('data-original-text');
    }, 2000);
  }
}
 </script>
{% endblock %}

{% endblock body %}
